"use strict";var TR3=new Object,THREE=new Object;function isMobile(){var e=!1;return void 0!==window.orientation&&(e=!0),e}function isIE(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("msie")?parseInt(e.split("msie")[1]):100}TR3.version="rev:2.121.10",TR3.imgOri=!1,TR3.imgDesty=!1,TR3.lock3d=!1,TR3.config=new Object,"undefined"!=typeof IIIkel?TR3.config=IIIkel.config.TR3:TR3.config={unic:!0,src:!1,flag3d:!0,rotate:!1,lookAt:!1,magni:"auto",spritesDskMvl:1,zoomMapDskMvl:0},TR3.setLoader=function(e,t){void 0===e&&(e=""),TR3.config.src=e,THREE=t.THREE||THREE,TR3.OrbitControls=t.OrbitControls||OrbitControls||THREE.OrbitControls,TR3.TransformControls=t.TransformControls||TransformControls||THREE.TransformControls,TR3.SkeletonUtils=t.SkeletonUtils||SkeletonUtils||THREE.SkeletonUtils,TR3.GLTFExporter=t.GLTFExporter||GLTFExporter||THREE.GLTFExporter,TR3.GLTFLoader=t.GLTFLoader||GLTFLoader||THREE.GLTFLoader,TR3.IFCLoader=t.IFCLoader||IFCLoader||THREE.IFCLoader,TR3.Sky=t.Sky||Sky||THREE.Sky},TR3.setPanel=function(){var e='\t\t\t\t<div id="3doptions" style="border: solid;margin: 5px; padding: 5px; display: none;float:left">\t\t\t\t\t<label id="lblSroOpt" style="font-weight: bold;margin-bottom: 5px;border: solid 2px royalblue;text-align: center;color: royalblue;cursor: pointer">▲ Herramientas 3D ▲</label>\t\t\t\t\t<div id="sroOpt" style="display:none">\t\t\t\t\t\t<div id="magnificationSliderValue">Exagerar x</div>\t\t\t\t\t\t<input type="button" class="magniStep" style="float:left" value="&nbsp;-&nbsp;"><div id="magnificationSlider" style="float:left;width:95px;margin:4px"></div><input type="button" class="magniStep" style="float:left" value="+">\t\t\t\t\t\t\x3c!--<label><input class="changeOpt" id="DTMcheck" type="checkbox"> DTM  alternativo WCS</label><br>--\x3e\t\t\t\t\t\t<label style="width:150px;float:left"><input class="changeOpt" id="cursorCheck" type="checkbox"><span id="cursorCheck_spm">▲ 3D Cursor ▲</span></label><br>\t\t\t\t\t\t<div id="cursorCheck_div" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<input id="newLine" style="float:left;" type="button" value=" Línea " class="">\t\t\t\t\t\t\t<input id="newPolig" style="float:left;" type="button" value=" Polígono " class="">\t\t\t\t\t\t\t<span><input id="metrics" type="checkbox" style="margin:3px 0 3px 3px">Medir</span><br>\t\t\t\t\t\t\t<input id="PickDrawStereo" type="text" style="width: 50px;"; value="#ff6161">\t\t\t\t\t\t\t<input id="del_vGeom" type="button" value="Borrar Todo" class="">\t\t\t\t\t\t\t<span>Valor de Z: </span><input id="setZ" type="text" style="width: 50px;"; value=""><span id="helpSetZ" style="color:royalblue;text-decoration:underline;cursor:pointer">Ayuda</span>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label><input class="changeOpt" id="anaglyphCheck" type="checkbox"><span id="anaglyphCheck_spm">▲ Stereo 3D ▲</span></label>\t\t\t\t\t\t<div id="anaglyphType" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<span>&nbsp;- Modo: </span><select id="anaglyph-type" onchange="TR3.changeAnaglyphType()">\t\t\t\t\t\t\t\t<option value="optimiced">Optimizado</option>\t\t\t\t\t\t\t\t<option value="normal">Normal</option>\t\t\t\t\t\t\t\t<option value="half">Intermedio</option>\t\t\t\t\t\t\t\t<option value="gray">Gris</option>\t\t\t\t\t\t\t\t<option value="interlaced">Entrelazado</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<a target="_blank" href="'+TR3.config.src+'docStereo.pdf">Gafas 3d</a>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div style="float:left">\t\t\t\t\t\t\t<input id="file_3d" type="file" accept=".glb,.ifc" style="opacity: 0; position: absolute; width: 100px;">\t\t\t\t\t\t\t<input id="file_3d_fake" style="color: gray; width: 100px;" value=" Explorar GLB/IFC... ">\t\t\t\t\t\t\t<input id="del3dObj" type="button" value=" Fin ">\t\t\t\t\t\t\t<span id="help3dObj" style="color:royalblue;text-decoration:underline;cursor:pointer"> Ayuda</span><br>\t\t\t\t\t\t\t<span>&nbsp;- Exportar ⇩ </span><select id="exporter-type" onchange="TR3.changeExportType()">\t\t\t\t\t\t\t\t<option value="null" style="background-color:#ccc" selected>tipo GLTF</option>\t\t\t\t\t\t\t\t<option value="terrain">Terreno</option>\t\t\t\t\t\t\t\t<option value="obj3d">Objetos</option>\t\t\t\t\t\t\t\t<option value="items">Vectores</option>\t\t\t\t\t\t\t\t<option value="scene">Todo</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<label id="size3dObj"></label>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<div id="orbitalMoves" style="width: 155px; text-align: center; box-shadow: rgb(136, 136, 136) 1px 1px 5px; border: medium outset #eee; float: left;">\t\t\t\t\t\t<img id="imgOrbitalMoves" src="'+TR3.config.src+'img/eartharrow.png" draggable="false" style="margin: 5px;cursor:pointer"><br>\t\t\t\t\t\t<input id="makeScene" type="button" value=" Restablecer " style="margin-bottom:5px" class=""><br>\t\t\t\t\t\t<input id="pWalking" type="button" value=" Caminar " style="" class="">\t\t\t\t\t\t<input id="pFlying" type="button" value=" &nbsp;Volar&nbsp; " style="" class="">\t\t\t\t\t\t<input id="orbitPoint" type="button" value=" Orbitar " style="" class="">\t\t\t\t\t\t<div id="exploreDiv" style="display:none">\t\t\t\t\t\t\t<div id="personFlySliderDiv" style="display:none">\t\t\t\t\t\t\t\t<div id="heightSliderValue">Altitud: </div>\t\t\t\t\t\t\t\t<div id="heightSlider" style="margin:5px"></div></div>\t\t\t\t\t\t\t<input id="lessV" type="button" value="- Velocidad"><input id="moreV" type="button" value="+ Velocidad">\t\t\t\t\t\t\t<label style="font-weight: bold; margin: 5px;color: brown;">Camina y Vuela con las flechas de teclado</label>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div style="text-align: left; margin: 5px">\t\t\t\t\t\t\t<input id="autoRotate" type="checkbox" class="changeOpt"> Rotación \t\t\t\t\t\t\t<input id="malla" type="checkbox" class="changeOpt"> Malla\t\t\t\t\t\t\t<input id="tentative" type="checkbox" class="changeOpt" checked> Tentativo\t\t\t\t\t\t\t<input id="cheapMode" type="checkbox" class="changeOpt"> Min\t\t\t\t\t\t</div>\t\t\t\t\t</div>',t="";return TR3.config.unic||(t='<div id="slctScenes"><b><div align="center"><input id="viewScenes" type="checkbox" class="" checked> Acceso a Escenas:</div></b>\t\t\t\t\t\t<div align="center" id="btnsScenes">\t\t\t\t\t\t\t<input id="acc2scn" type="button" value=" Paisajes Increíbles " style="color:royalblue;" class="">\t\t\t\t\t\t</div>\t\t\t\t\t</div>'),e+t+'</div><img id="imgErrTR3evt" src onerror="TR3.setEvtPanel()">\t\t\t\t<div id="advices"></div>'},TR3.setEvtPanel=function(){$("#magnificationSlider").slider({min:1,max:15,slide:function(e,t){var o=TR3.formatMeasure(TR3.tPixMesh);$("#magnificationSliderValue").html("Exagerar <b>x"+t.value+"</b> (malla: "+o[0]+o[1]+")"),TR3.setMagniValues(t.value)}}),$("#heightSlider").slider({min:0,max:1e3,slide:function(e,t){$("#heightSlider").slider("option","max",Math.round((TR3.zMax-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSlider").slider("option","min",Math.round((TR3.zMin-TR3.zMed)*TR3.valuesSet.magnification)),TR3.changeHeight(t.value,!0,!1),$("#heightSliderValue").html("Altitud: "+Math.round(t.value/TR3.valuesSet.magnification+TR3.zMed)+" m")}}),$("#anaglyphCheck").on("change",function(){this.checked?(document.getElementById("anaglyphType").style.display="block",document.getElementById("anaglyphCheck_spm").innerHTML="▼ Stereo 3D ▼"):(document.getElementById("anaglyphType").style.display="none",document.getElementById("anaglyphCheck_spm").innerHTML="▲ Stereo 3D ▲")}),$("#viewScenes").on("change",function(){this.checked?(document.getElementById("btnsScenes").style.display="block",TR3.viewScenes=!0):(document.getElementById("btnsScenes").style.display="none",TR3.viewScenes=!1)});$("#PickDrawStereo").minicolors({animationSpeed:50,animationEasing:"swing",change:null,changeDelay:0,control:"hue",defaultValue:"",format:"rgb",showSpeed:100,hideSpeed:100,inline:!1,keywords:"",letterCase:"lowercase",opacity:!1,position:"bottom left",theme:"default TR3PickColor",swatches:[]});for(var e=document.getElementsByClassName("changeOpt"),t=0;t<e.length;t++)e[t].addEventListener("click",TR3.setOpts,!1);TR3.config.unic||document.getElementById("acc2scn").addEventListener("click",function(){IIIkel.container.ctxScenes.show()},!1),document.getElementById("makeScene").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.setValuesSliderMagn("auto"),TR3.moving=!1,TR3.initPosCamera(!0),TR3.cursor.helper.scale.set(1,1,1),document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("orbitPoint").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.moving=!1,TR3.orbitalViewFn(),document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("pWalking").addEventListener("click",function(){TR3.lightBtn(this.id),this.blur(),TR3.moving=!0,TR3.personViewFn(),TR3.moveKey.walk=!0,TR3.optionsSet.imgControl?document.getElementById("imgOrbitalMoves").focus():document.getElementById("canvasDest").focus(),document.getElementById("exploreDiv").style.display="block",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("pFlying").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.moving=!0;var e=(TR3.zMax-TR3.zMin)/2*TR3.valuesSet.magnification;TR3.personViewFn(e),TR3.setValuesSliderHeight(e),TR3.moveKey.walk=!1,TR3.optionsSet.imgControl?document.getElementById("imgOrbitalMoves").focus():document.getElementById("canvasDest").focus(),document.getElementById("exploreDiv").style.display="block",document.getElementById("personFlySliderDiv").style.display="block",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("cursorCheck").addEventListener("click",function(){document.getElementById("cursorCheck").checked?(document.getElementById("cursorCheck_div").style.display="block",document.getElementById("cursorCheck_spm").innerHTML="▼ 3d cursor ▼",TR3.lock3d("cursor3d")):(document.getElementById("cursorCheck_div").style.display="none",document.getElementById("cursorCheck_spm").innerHTML="▲ 3d cursor ▲",document.getElementById("metrics").checked=!1,TR3.vGeom.measure=!1,TR3.endDraw(),TR3.unlock3d("cursor3d"))},!1),document.getElementById("metrics").addEventListener("click",function(){document.getElementById("metrics").checked?TR3.vGeom.measure=!0:TR3.vGeom.measure=!1},!1),document.getElementById("lblSroOpt").addEventListener("click",function(){var e=document.getElementById("sroOpt").style.display,t=document.getElementById("lblSroOpt");"none"==e?(document.getElementById("sroOpt").style.display="block",t.innerHTML="▼ Herramientas 3D ▼"):(document.getElementById("sroOpt").style.display="none",t.innerHTML="▲ Herramientas 3D ▲")},!1);var o=document.getElementById("imgOrbitalMoves");o.addEventListener("mouseover",function(){o.src=TR3.config.src+"img/eartharrow_over.png"},!1),o.addEventListener("mouseout",function(){o.src=TR3.config.src+"img/eartharrow.png"},!1),document.getElementById("moreV").addEventListener("click",function(){TR3.optionsSet.imgControl?o.focus():TR3.canvasDest.focus(),TR3.controls.keyPanSpeed=3*TR3.controls.keyPanSpeed},!1),document.getElementById("lessV").addEventListener("click",function(){TR3.optionsSet.imgControl?o.focus():TR3.canvasDest.focus(),TR3.controls.keyPanSpeed=TR3.controls.keyPanSpeed/3},!1),document.getElementById("newLine").addEventListener("click",function(){TR3.vGeom.polig=!1,TR3.newVgeom()},!1),document.getElementById("newPolig").addEventListener("click",function(){TR3.vGeom.polig=!0,TR3.newVgeom()},!1),document.getElementById("del_vGeom").addEventListener("click",function(){TR3.del_vGeom(),document.getElementById("metrics").checked=!1},!1),document.getElementById("file_3d").addEventListener("change",function(e){TR3.handleFileSelect(e)},!1),document.getElementById("del3dObj").addEventListener("click",function(){document.getElementById("file_3d").value="",document.getElementById("file_3d_fake").value=" Explorar GLB/IFC... ",TR3.sourceFile=!1},!1),document.getElementById("help3dObj").addEventListener("click",function(){document.getElementById("advices").innerHTML='<div id="infohelp3dObj" style="padding:10px">\t\t\t\t\t\t<div align="center"><u>Carga el modelo y Presiona la tecla:</u></div><br />\t\t\t\t\t\t<b>"W"</b> Trasladar | <b>"E"</b> Rotar | <b>"R"</b> scale<br />\t\t\t\t\t\t<b>"+"</b> Aumentar | <b>"-"</b> Disminuir<br />\t\t\t\t\t\t<b>"Q"</b> Cambia world/local espacio <br />\t\t\t\t\t\t<b>"X"</b> Cambia X | <b>"Y"</b> Cambia Y | <b>"Z"</b> Cambia Z<br />\t\t\t\t\t\t<b>"Barra espaciadora"</b> activa/desactiva <br /><br />\t\t\t\t\t\t<div align="center"><u>Hazlo tú mismo:</u></div>\t\t\t\t\t\t<b>1) Modelos 3D:</b><a href="https://sketchfab.com/" target="_blank"> sketchfab</a><br />\t\t\t\t\t\t<b>2) GLTF to GLB:</b><a href="https://glb-packer.glitch.me/" target="_blank"> glb-packer</a><br />\t\t\t\t\t\t<b>3) ¡Úsalo aquí!</b><br />\t\t\t\t\t\tVisor GLTF: <a href="https://gltf-viewer.donmccurdy.com/" target="_blank"> gltf viewer</a><br />\t\t\t\t\t</div>',$("#advices").dialog()},!1),document.getElementById("helpSetZ").addEventListener("click",function(){document.getElementById("advices").innerHTML='<div id="infohelpSetZ" style="padding:10px">\t\t\t\t\t\t<div align="center"><u>Introduce valor de Z y Presiona la tecla:</u></div><br />\t\t\t\t\t\t<b>"Alt"</b> Cambia Z Terreno<br />\t\t\t\t\t\t<b>"Shift"</b> Cambia Z Cursor<br />\t\t\t\t\t</div>',$("#advices").dialog()},!1);var a=document.getElementsByClassName("magniStep");for(t=0;t<a.length;t++)a[t].addEventListener("click",function(e){var t=e.target.value,o=TR3.valuesSet.magnification;-1!=t.indexOf("+")?15<(o+=1)&&(o=15):(o-=1)<1&&(o=1),TR3.setValuesSliderMagn(o)})},TR3.lightBtn=function(e){for(var t=document.getElementsByClassName("btnDrawOn"),o=0;o<t.length;o++)t[o].style.border="",t[o].className="";"makeScene"==e&&(e="orbitPoint"),document.getElementById(e).className="btnDrawOn",document.getElementById(e).style.border="solid 2px"},TR3.setStart=function(e){TR3.dfd_setMap=$.Deferred(),void 0===e&&(e={});var t=!!e.hasOwnProperty("ori")&&e.ori;TR3.map=!!e.hasOwnProperty("desty")&&e.desty;var o=!!e.hasOwnProperty("bbox")&&e.bbox;TR3.srsImg=e.hasOwnProperty("projCode")?e.projCode:"EPSG:25830",TR3.LyrFeatFromOri=!!e.hasOwnProperty("LyrFeat")&&e.LyrFeat,"object"!=typeof t&&((t=document.getElementById(t))||alert("invalid Origin")),"object"!=typeof TR3.map&&(TR3.map=document.getElementById(TR3.map),TR3.map||alert("invalid Destiny"));var a=TR3.getOptions(),n=TR3.getValues();return TR3.sprite=TR3.config.sprite||!0,TR3.setMeshMap(t,o,a,{magnification:n,lookAt:TR3.config.lookAt}),TR3.config.lookAt=!1,TR3.setValuesSliderMagn(n),TR3.config.magni="auto",TR3.vGeom.measure=!1,TR3.startAnimation(),document.getElementById("metrics").checked=!1,document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.dfd_setMap.promise()},TR3.getOptions=function(){var e,t,o,a;return e="none"!=document.getElementById("imgOrbitalMoves").style.display,t=!!document.getElementById("cursorCheck")&&document.getElementById("cursorCheck").checked,o=!!document.getElementById("anaglyphCheck")&&document.getElementById("anaglyphCheck").checked,a=!!document.getElementById("autoRotate")&&document.getElementById("autoRotate").checked,1==TR3.config.rotate&&(a=!(TR3.config.rotate=0)),{imgControl:e,cursor3d:t,anaglyph:o,autoRotate:a,wireframeMesh:!!document.getElementById("malla")&&document.getElementById("malla").checked,tentative:!!document.getElementById("tentative")&&document.getElementById("tentative").checked,cheapMode:!!document.getElementById("cheapMode")&&document.getElementById("cheapMode").checked}},TR3.setOpts=function(e){var t=TR3.getOptions();e&&(null!=e.imgControl&&(t.imgControl=e.imgControl),null!=e.cursor3d&&(t.cursor3d=e.cursor3d),null!=e.anaglyph&&(t.anaglyph=e.anaglyph),null!=e.autoRotate&&(t.autoRotate=e.autoRotate),null!=e.wireframeMesh&&(t.wireframeMesh=e.wireframeMesh),null!=e.tentative&&(t.tentative=e.tentative),null!=e.cheapMode&&(t.cheapMode=e.cheapMode)),TR3.setOptions(t.imgControl,t.cursor3d,t.anaglyph,t.autoRotate,t.wireframeMesh,t.tentative,t.cheapMode)},TR3.setOptions=function(e,t,o,a,n,r,i){if(document.getElementById("imgOrbitalMoves").style.display=1==e?"inline":"none",document.getElementById("cursorCheck").checked=1==t,document.getElementById("malla").checked=1==n,document.getElementById("autoRotate").checked=1==a,document.getElementById("anaglyphCheck").checked=1==o,document.getElementById("tentative").checked=1==r,document.getElementById("cheapMode").checked=1==i,TR3.map){var s=document.getElementById("infoGeo3d"),l=document.getElementById("cursorCheck_div");if(1==t?(l.style.display="block",s.style.display="block",TR3.map.style.cursor="none",TR3.cursor.helper.visible=!0,TR3.controls.enableZoom=!1):(l.style.display="none",s.style.display="none",TR3.map.style.cursor="auto",TR3.cursor.helper.visible=!1,TR3.controls.enableZoom=!0),TR3.mesh.material.wireframe=1==n,TR3.controls.autoRotate=1==a,1==o){var c=TR3.getIntersect();if(0<c.length){var T=TR3.camera.position;TR3.zeroParallax=T.distanceTo(c[0].point)}}1==i?(TR3.scene.remove(TR3.sky),TR3.scene.remove(TR3.moon),TR3.scene.remove(TR3.starField)):(TR3.scene.add(TR3.sky),TR3.scene.add(TR3.moon),TR3.scene.add(TR3.starField))}TR3.optionsSet={imgControl:e,cursor3d:t,anaglyph:o,autoRotate:a,wireframeMesh:n,tentative:r,cheapMode:i}},TR3.setValues=function(magni){var magnific="auto";"number"!=typeof Number(magni)||isNaN(magni)||(magnific=eval(magni)),TR3.config.magni=magnific,TR3.setValuesSliderMagn(magnific)},TR3.getValues=function(){return TR3.config.magni},TR3.changeAnaglyphType=function(){TR3.anaglyphType=document.getElementById("anaglyph-type").value,TR3.anaglyphRenderer.updateAnaglyphType(TR3.scene,TR3.camera)},TR3.changeExportType=function(){var e=document.getElementById("exporter-type").value;"null"!=e&&TR3.exportGLTF(e)},TR3.setValuesSliderMagn=function(e){e&&0<e&&e<51?TR3.setMagniValues(e):e="auto"==e?TR3.setMagniValues():TR3.valuesSet.magnification,$("#magnificationSlider").slider("value",e);var t=TR3.formatMeasure(TR3.tPixMesh);$("#magnificationSliderValue").html("Exagerar <b>x"+e+"</b> (malla: "+t[0]+" "+t[1]+")")},TR3.setValuesSliderHeight=function(e){$("#heightSlider").slider("value",e),$("#heightSlider").slider("option","max",Math.round((TR3.zMax-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSlider").slider("option","min",Math.round((TR3.zMin-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSliderValue").html("Altitud: "+Math.round(e/TR3.valuesSet.magnification+TR3.zMed)+" m")};var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){if(-1!=window.navigator.userAgent.indexOf("Windows NT 5")||isIE()<10)return!1;try{var e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,o,a;t=void 0!==(e=e||{}).parent?e.parent:document.body,o=void 0!==e.id?e.id:"oldie",(a=Detector.getWebGLErrorMessage()).id=o,t.appendChild(a)}},wmsMap=new Object;wmsMap.transCoord=function(){};var Datum_axis={ED50:[6378388,6356911.946],WGS84:[6378137,6356752.314],ETRS89:[6378137,6356752.314],WGS72:[6378135,6356750.52],OSGB36:[6377563.396,6356256.909]},datToDat={ETRS89toED50Pen:{tx:131.032,ty:100.251,tz:163.354,s:-939e-8,rx:-3455e-7,ry:-54166e-10,rz:-.0003176666},ED50toETRS89Pen:{tx:-131.032,ty:-100.251,tz:-163.354,s:939e-8,rx:3455e-7,ry:54166e-10,rz:.0003176666},ETRS89toED50Bal:{tx:181.4609,ty:90.2931,tz:187.1902,s:-1757e-8,rx:39861e-9,ry:136722e-9,rz:-109306e-9},ED50toETRS89Bal:{tx:-181.4609,ty:-90.2931,tz:-187.1902,s:1757e-8,rx:-39861e-9,ry:-136722e-9,rz:109306e-9},ETRS89toED50NWP:{tx:178.383,ty:83.172,tz:221.293,s:-212e-7,rx:150028e-9,ry:-14775e-8,rz:-35083e-9},ED50toETRS89NWP:{tx:-178.383,ty:-83.172,tz:-221.293,s:212e-7,rx:-150028e-9,ry:14775e-8,rz:35083e-9},WGS84toED50:{tx:89.5,ty:93.8,tz:123.1,s:-12e-7,rx:0,ry:0,rz:-433e-7},ED50toWGS84:{tx:-89.5,ty:-93.8,tz:-123.1,s:12e-7,rx:0,ry:0,rz:433e-7},OSGB36toWGS84:{tx:446.448,ty:-124.157,tz:542.06,s:-204894e-10,rx:4172222e-11,ry:6861111e-11,rz:.00023391666}};wmsMap.transCoord.getElipsoide=function(e){var t=Datum_axis[e][0],o=Datum_axis[e][1];return{a:t,b:o,e2:(t*t-o*o)/(t*t)}},wmsMap.transCoord.srsChange=function(e,t,o,a){var n=this.getDatum(o),r=this.getDatum(a);if(n.datum==r.datum){if(n.huso==r.huso)return{c1:e,c2:t};if(""==n.huso)return{c1:(s=this.geoToUTM(e,t,n.datum,r.huso)).x,c2:s.y};if(""==r.huso)return{c1:(s=this.utmToGeo(e,t,n.datum,n.huso)).lon,c2:s.lat};var i=this.utmToGeo(e,t,n.datum,n.huso);return{c1:(s=this.geoToUTM(i.lon,i.lat,n.datum,r.huso)).x,c2:s.y}}if(""==n.huso&&""==r.huso)return{c1:(s=this.changeDatum(e,t,n.datum,r.datum)).lon,c2:s.lat};if(""==n.huso&&""!=r.huso){var s=this.changeDatum(e,t,n.datum,r.datum);return{c1:(l=this.geoToUTM(s.lon,s.lat,r.datum,r.huso)).x,c2:l.y}}if(""!=n.huso&&""==r.huso){s=this.utmToGeo(e,t,n.datum,n.huso);return{c1:(l=this.changeDatum(s.lon,s.lat,n.datum,r.datum)).lon,c2:l.lat}}s=this.utmToGeo(e,t,n.datum,n.huso);var l=this.changeDatum(s.lon,s.lat,n.datum,r.datum),c=this.geoToUTM(l.lon,l.lat,r.datum,r.huso);return{c1:c.x,c2:c.y}},wmsMap.transCoord.getDatum=function(e){var t=e.length,o="",a="";if(10==t){var n="UTM";326==(r=e.slice(5,8))?o="WGS84":230==r?o="ED50":258==r&&(o="ETRS89"),a=e.slice(-2)}else if(9==t){var r;n="Lon-Lat";4326==(r=e.slice(5,9))?o="WGS84":4230==r?o="ED50":4258==r&&(o="ETRS89")}return{datum:o,huso:a,proy:n}},wmsMap.transCoord.getEPSG=function(e,t,o){var a,n,r=o;return"UTM"==e?a="":"Lon-Lat"==e&&(a="4",r=""),"ETRS89"==t?n="258":"ED50"==t?n="230":"WGS84"==t&&(n="326"),{EPSG:"EPSG:"+a+n+r}},wmsMap.transCoord.isGeo=function(e){return"Lon-Lat"==wmsMap.transCoord.getDatum(e).proy},wmsMap.transCoord.isUTM=function(e){return"UTM"==wmsMap.transCoord.getDatum(e).proy},wmsMap.transCoord.geoToUTM=function(e,t,o,a){var n=this.getElipsoide(o),r=n.a,i=n.e2,s=e,l=t,c=l*(Math.PI/180),T=s*(Math.PI/180);if(a)var d=a;else d=Math.floor((s+180)/6)+1;56<=l&&l<64&&3<=s&&s<12&&(d=32),72<=l&&l<84&&(0<=s&&s<9?d=31:9<=s&&s<21?d=33:21<=s&&s<33?d=35:33<=s&&s<42&&(d=37));var R=(6*(d-1)-180+3)*(Math.PI/180);ePrimeSquared=i/(1-i);var m=r/Math.sqrt(1-i*Math.sin(c)*Math.sin(c)),u=Math.tan(c)*Math.tan(c),p=ePrimeSquared*Math.cos(c)*Math.cos(c),g=Math.cos(c)*(T-R),v=r*((1-i/4-3*i*i/64-5*i*i*i/256)*c-(3*i/8+3*i*i/32+45*i*i*i/1024)*Math.sin(2*c)+(15*i*i/256+45*i*i*i/1024)*Math.sin(4*c)-35*i*i*i/3072*Math.sin(6*c)),h=.9996*m*(g+(1-u+p)*Math.pow(g,3)/6+(5-18*u+u*u+72*p-58*ePrimeSquared)*Math.pow(g,5)/120)+5e5,f=.9996*(v+m*Math.tan(c)*(g*g/2+(5-u+9*p+4*p*p)*Math.pow(g,4)/24+(61-58*u+u*u+600*p-330*ePrimeSquared)*Math.pow(g,6)/720));return l<0&&(f+=1e7),{x:h,y:f}},wmsMap.transCoord.utmToGeo=function(e,t,o,a){var n=this.getElipsoide(o),r=n.a,i=n.e2,s=i/(1-i),l=(1-Math.sqrt(1-i))/(1+Math.sqrt(1-i)),c=(e=e-5e5,6*(a-1)-180+3),T=(t=t)/.9996/(r*(1-i/4-3*i*i/64-5*Math.pow(i,3)/256)),d=T+(3*l/2-27*Math.pow(l,3)/32)*Math.sin(2*T)+(21*l*l/16-55*Math.pow(l,4)/32)*Math.sin(4*T)+151*Math.pow(l,3)/96*Math.sin(6*T),R=r/Math.sqrt(1-i*Math.sin(d)*Math.sin(d)),m=Math.tan(d)*Math.tan(d),u=s*Math.cos(d)*Math.cos(d),p=r*(1-i)/Math.pow(1-i*Math.sin(d)*Math.sin(d),1.5),g=e/(.9996*R),v=(d-R*Math.tan(d)/p*(g*g/2-(5+3*m+10*u-4*u*u-9*s)*Math.pow(g,4)/24+(61+90*m+298*u+45*m*m-252*s-3*u*u)*Math.pow(g,6)/720))*(180/Math.PI);return{lon:c+(g-(1+2*m+u)*Math.pow(g,3)/6+(5-2*u+28*m-3*u*u+8*s+24*m*m)*Math.pow(g,5)/120)/Math.cos(d)*(180/Math.PI),lat:v}},wmsMap.transCoord.GeoToGeocentric=function(e,t,o){var a=this.getElipsoide(o),n=a.a,r=(a.b,a.e2),i=wmsMap.oper.degToRad(t),s=wmsMap.oper.degToRad(e),l=n/Math.sqrt(1-r*wmsMap.oper.sin2(i));return{x:(0+l)*Math.cos(i)*Math.cos(s),y:(0+l)*Math.cos(i)*Math.sin(s),z:((1-r)*l+0)*Math.sin(i)}},wmsMap.transCoord.GeocentricToGeo=function(e,t,o,n){elipsoide=this.getElipsoide(n),a=elipsoide.a,b=elipsoide.b,excen=elipsoide.e2;for(var r=wmsMap.oper.radToDeg(Math.atan(t/e)),i=Math.sqrt(e*e+t*t),s=Math.atan(o/(i*(1-excen))),l=1;l<10;l++)v=a/Math.sqrt(1-excen*wmsMap.oper.sin2(s)),phiN1=Math.atan((o+excen*v*Math.sin(s))/i),s=phiN1;return{lon:r,lat:wmsMap.oper.radToDeg(s)}},wmsMap.transCoord.bursaWolf=function(e,t,o,a){var n=a.tx,r=a.ty,i=a.tz,s=a.s,l=wmsMap.oper.degToRad(a.rx),c=wmsMap.oper.degToRad(a.ry),T=wmsMap.oper.degToRad(a.rz),d=Math.sin(c),R=Math.cos(c),m=Math.sin(l),u=Math.cos(l),p=Math.sin(T),g=Math.cos(T),v=1+s,h=[[],[],[]];return h[0][0]=v*(R*g),h[1][0]=v*(-R*p),h[2][0]=v*d,h[0][1]=v*(m*d*g+u*p),h[1][1]=v*(-m*d*p+u*g),h[2][1]=v*(-m*R),h[0][2]=v*(-u*d*g+m*p),h[1][2]=v*(u*d*p+m*g),h[2][2]=v*(u*R),{x:h[0][0]*e+h[0][1]*t+h[0][2]*o+n,y:h[1][0]*e+h[1][1]*t+h[1][2]*o+r,z:h[2][0]*e+h[2][1]*t+h[2][2]*o+i}},wmsMap.transCoord.changeDatum=function(e,t,o,a){if("ETRS89"==o&&"WGS84"==a||"ETRS89"==a&&"WGS84"==o)return{lon:e,lat:t};gcIn=wmsMap.transCoord.GeoToGeocentric(e,t,o);var n=this.getParam(o,a,e,t);return gcOut=wmsMap.transCoord.bursaWolf(gcIn.x,gcIn.y,gcIn.z,n),gOut=wmsMap.transCoord.GeocentricToGeo(gcOut.x,gcOut.y,gcOut.z,a),{lon:gOut.lon,lat:gOut.lat}},wmsMap.transCoord.getParam=function(e,t,o,a){var n,r;return r=-9.416<o&&o<-4.5&&41.5<a&&a<43.833?(n=datToDat.ETRS89toED50NWP,datToDat.ED50toETRS89NWP):1<o&&o<4.5&&38.5<a&&a<40.3?(n=datToDat.ETRS89toED50Bal,datToDat.ED50toETRS89Bal):-10<o&&o<3.833&&35.5<a&&a<44.833?(n=datToDat.ETRS89toED50Pen,datToDat.ED50toETRS89Pen):(n=datToDat.WGS84toED50,datToDat.ED50toWGS84),"ETRS89"==e&&"ED50"==t?n:"ED50"==e&&"ETRS89"==t?r:"WGS84"==e&&"ED50"==t?datToDat.WGS84toED50:"ED50"==e&&"WGS84"==t?datToDat.ED50toWGS84:"OSGB36"==e&&"WGS84"==t?datToDat.OSGB36toWGS84:void 0},wmsMap.transCoord.getGradMinSeg=function(e,t){var o=60*(Math.floor(e)-e),a=60*(Math.floor(t)-t),n=Math.floor(60*(o-Math.floor(o))),r=Math.floor(60*(a-Math.floor(a)));if(0<=e)var i=Math.floor(e)+"&ordm;"+Math.floor(Math.abs(o))+"'"+Math.abs(n-59)+"''";else i="-"+Math.abs(Math.ceil(e))+"&ordm;"+Math.floor(60+o)+"'"+n+"''";return{lon:i,lat:Math.floor(t)+"&ordm;"+Math.floor(Math.abs(a))+"'"+Math.abs(r-59)+"''"}},wmsMap.transCoord.getGradDeci=function(e,t,o){return(e=e||0)+(t=t||0)/60+(o=o||0)/3600},wmsMap.transCoord.getSuperficie=function(matrix,datum){for(var c,vect=[],matrixAux=[],i=0;i<matrix.length;i++){c=wmsMap.transCoord.geoToUTM(eval(matrix[i][0]),eval(matrix[i][1]),datum,30);var vect=[];vect[0]=c.x,vect[1]=c.y,matrixAux.push(vect)}var superf=0,n=matrixAux.length;if(matrixAux[0][0]==matrixAux[n-1][0]&&matrixAux[0][1]==matrixAux[n-1][1]){for(var j=0;j<n-1;j++)superf+=-matrixAux[j][0]*matrixAux[j+1][1]+matrixAux[j+1][0]*matrixAux[j][1];return Math.abs(superf/2)}for(var j=0;j<n-1;j++)superf+=-matrixAux[j][0]*matrixAux[j+1][1]+matrixAux[j+1][0]*matrixAux[j][1];return superf+=-matrixAux[n-1][0]*matrixAux[0][1]+matrixAux[0][0]*matrixAux[n-1][1],Math.abs(superf/2)},wmsMap.transCoord.normalizeDegrees=function(e){var t=[360,180];return e[0]<-t[0]&&(e[0]+=t[0],e[2]+=t[0]),e[2]>t[0]&&(e[2]-=t[0],e[0]-=t[0]),e[1]<-t[1]&&(e[1]+=t[1],e[3]+=t[1]),e[3]>t[1]&&(e[3]-=t[1],e[1]-=t[1]),e},wmsMap.transCoord.geoZone=function(e,t,o){if("UTM"==this.getDatum(o).proy)var a=this.srsChange(e,t,o,"EPSG:4258");else a={c1:e,c2:t};return Math.floor((a.c1+180)/6)+1},wmsMap.transCoord.tw2c=function(e,t,o,a,n){var r={},i={};if(a.x00){var s=e-parseFloat(a["x0"+n]),l=t-parseFloat(a["y0"+n]),c=o-parseFloat(a["z0"+n]);daux=-parseFloat(a["df"+n])/(parseFloat(a["r"+n][2])*s+parseFloat(a["r"+n][5])*l+parseFloat(a["r"+n][8])*c),r.x=(parseFloat(a["r"+n][0])*s+parseFloat(a["r"+n][3])*l+parseFloat(a["r"+n][6])*c)*daux,r.y=(parseFloat(a["r"+n][1])*s+parseFloat(a["r"+n][4])*l+parseFloat(a["r"+n][7])*c)*daux,i=wmsMap.tAfinDirect(r,a["tx"+n],a["ty"+n],a.r);var T=YAHOO.util.Dom.getStyle("contIzq","height");T&&(i.y=parseInt(T)-i.y)}else i.x=(a[0+8*n]*e*100+a[1+8*n])/(100*o+a[2+8*n])+a[3+8*n],i.y=(a[4+8*n]*t*100+a[5+8*n])/(100*o+a[6+8*n])+a[7+8*n];return i},wmsMap.tAfinDirect=function(e,t,o,a){var n={};return n.x=parseFloat(a[0])*e.x+parseFloat(a[1])*e.y+parseFloat(t),n.y=parseFloat(a[2])*e.x+parseFloat(a[3])*e.y+parseFloat(o),n},wmsMap.tAfinInver=function(e,t,o,a){var n=e.x,r=e.y,i={},s=a[0]*a[3]-a[2]*a[1];return s&&(i.x=(parseFloat(a[3])*n-parseFloat(a[1])*r-parseFloat(a[3])*t+parseFloat(a[1])*o)/s,i.y=(-parseFloat(a[2])*n+parseFloat(a[0])*r-parseFloat(a[0])*o+parseFloat(a[2])*t)/s),i},TR3.AnaglyphEffect=function(T,e,t){var d,R,m,u,p=new THREE.Matrix4,g=new THREE.Matrix4,v=200,h=200,f=new THREE.PerspectiveCamera;f.matrixAutoUpdate=!1;var y=new THREE.PerspectiveCamera;y.matrixAutoUpdate=!1;var b=new THREE.OrthographicCamera(-1,1,1,-1,0,1),M=new THREE.Scene,o={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat};void 0===e&&(e=512),void 0===t&&(t=512);var E=new THREE.WebGLRenderTarget(e,t,o),w=new THREE.WebGLRenderTarget(e,t,o);this.getAnaglyphColors=function(){var e="";TR3&&(e=TR3.anaglyphType);var t={lr1:"0.0",lg1:"0.7",lb1:"0.3",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};switch(e){case"normal":t={lr1:"1.0",lg1:"0.0",lb1:"0.0",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};break;case"half":t={lr1:"0.299",lg1:"0.587",lb1:"0.114",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};break;case"gray":t={lr1:"0.299",lg1:"0.587",lb1:"0.114",rr2:"0.299",rg2:"0.587",rb2:"0.114",rr3:"0.299",rg3:"0.587",rb3:"0.114"}}return t},this.getFragmentShader=function(){var e=this.getAnaglyphColors(),t=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec4 colorL, colorR;","\tvec2 uv = vUv;","\tcolorL = texture2D( mapLeft, uv );","\tcolorR = texture2D( mapRight, uv );","\tgl_FragColor = vec4( colorL.r * "+e.lr1+" + colorL.g * "+e.lg1+" + colorL.b * "+e.lb1+", colorR.r * "+e.rr2+" + colorR.g * "+e.rg2+" + colorR.b * "+e.rb2+", colorR.r * "+e.rr3+" + colorR.g * "+e.rg3+" + colorR.b * "+e.rb3+", colorL.a + colorR.a ) * 1.1;","}"].join("\n");return TR3&&"interlaced"==TR3.anaglyphType?t=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) < 1.00 ) {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t}","}"].join("\n"):TR3&&"interlaced swap"==TR3.anaglyphType&&(t=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) < 1.00 ) {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t}","}"].join("\n")),t};var a=new THREE.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:E},mapRight:{type:"t",value:w}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = vec2( uv.x, uv.y );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:this.getFragmentShader()}),n=new THREE.Mesh(new THREE.PlaneGeometry(2,2),a);M.add(n),this.setSize=function(e,t){E&&E.dispose(),w&&w.dispose(),E=new THREE.WebGLRenderTarget(e,t,o),w=new THREE.WebGLRenderTarget(e,t,o),a.uniforms.mapLeft.value=E,a.uniforms.mapRight.value=w,T.setSize(e,t)},this.render=function(e,t,o){var a=T.getRenderTarget();if(e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),d!==t.aspect||R!==t.near||m!==t.far||u!==t.fov||v!==o){d=t.aspect,R=t.near,m=t.far,u=t.fov,h=v=o;var n,r,i=t.projectionMatrix.clone(),s=h/30*.5,l=s*R/h,c=R*Math.tan(THREE.Math.degToRad(.5*u));p.elements[12]=s,g.elements[12]=-s,n=-c*d+l,r=c*d+l,i.elements[0]=2*R/(r-n),i.elements[8]=(r+n)/(r-n),f.projectionMatrix.copy(i),n=-c*d-l,r=c*d-l,i.elements[0]=2*R/(r-n),i.elements[8]=(r+n)/(r-n),y.projectionMatrix.copy(i)}f.matrixWorld.copy(t.matrixWorld).multiply(g),f.position.copy(t.position),f.near=t.near,f.far=t.far,T.setRenderTarget(E),T.clear(),T.render(e,f),y.matrixWorld.copy(t.matrixWorld).multiply(p),y.position.copy(t.position),y.near=t.near,y.far=t.far,T.setRenderTarget(w),T.clear(),T.render(e,y),T.setRenderTarget(null),T.render(M,b),T.setRenderTarget(a)},this.dispose=function(){E&&E.dispose(),w&&w.dispose()},this.updateAnaglyphType=function(e,t){this.getAnaglyphColors();a.fragmentShader=this.getFragmentShader(),a.needsUpdate=!0,this.render(e,t,v)}},TR3.getIntersect=function(e,t){var o=TR3.getRayCaster(e),a=t||TR3.mesh,n=!1;if("mesh3d"==a.name)0<(l=o.intersectObject(a)).length&&(n=l);else for(var r=0;r<a.length;r++){var i,s=a[r];i=s.scene?s.scene:s.parent&&s.parent.scene?s.parent.scene:s;var l=o.intersectObject(i,!0),c=s.scaleByCode;if(0<l.length&&"string"!=typeof c){if(n=s,TR3.intersectEvOver(n),1==TR3.optionsSet.tentative)c.length<4&&(c[3]="XYZ"),!1===c&&(c[3]=""),-1<(T=c[3].toLowerCase()).indexOf("x")&&(i.scale.x=1.3*i.scale.x),-1<T.indexOf("y")&&(i.scale.y=1.3*i.scale.y),-1<T.indexOf("z")&&(i.scale.z=1.3*i.scale.z),1==s.autoRotation&&(s.autoRotation=1e-11),s.scaleByCode=c.toString();r=a.length}else if(l.length<1){var T;if("string"==typeof c)c=c.split(","),(s.scaleByCode=c).length<4&&(c[3]="XYZ"),!1===c&&(c[3]=""),-1<(T=c[3].toLowerCase()).indexOf("x")&&(i.scale.x=i.scale.x/1.3),-1<T.indexOf("y")&&(i.scale.y=i.scale.y/1.3),-1<T.indexOf("z")&&(i.scale.z=i.scale.z/1.3),1e-11==s.autoRotation&&(s.autoRotation=!0)}else n=s}return n},TR3.getRayCaster=function(e){for(var t,o,a=TR3.map,n=a.offsetTop,r=a.offsetLeft;a.parentElement;)n+=(a=a.parentElement).offsetTop,r+=a.offsetLeft;e&&e.touches?(t=e.touches[0].clientX,o=e.touches[0].clientY):e?(t=e.clientX,o=e.clientY):(t=.5*TR3.canvasDestW,o=.5*TR3.canvasDestH,n=r=0);var i=(t-r)/TR3.canvasDestW*2-1,s=-(o-n)/TR3.canvasDestH*2+1,l=new THREE.Vector3(i,s,TR3.camera.near);l.unproject(TR3.camera);var c=TR3.camera.position;return new THREE.Raycaster(c,l.sub(c).normalize())},TR3.onIntersect=function(e){if(TR3.optionsSet.cursor3d){if(0<(d=TR3.getIntersect(e)).length){var t=d[0],o=d[0].point,a=(t.face,t.object,TR3.mesh.geometry),n=o.y,r=!1,i=TR3.cursor.setZterr;if(Number.isInteger(i)&&18==TR3.cursor.setkCde){var s=t.faceIndex;n=TR3.zM2T(i,!0);for(var l=0;l<4;l++){var c=a.index.array[3*s+l];a.attributes.position.setZ(c,n),TR3.arrayZ[c]=n}a.attributes.position.needsUpdate=!0}else Number.isInteger(i)&&16==TR3.cursor.setkCde&&(r=n=TR3.zM2T(i,!0));TR3.cursor.helper.position.set(o.x,n,o.z),TR3.redrawInfo(o.x,o.y,o.z,r),TR3.vGeom.drawVector=TR3.cursor.helper.position}}else{var T=TR3.getSelectableObj();if(0<T.length)var d=TR3.getIntersect(e,T)}},TR3.getSelectableObj=function(){for(var e=TR3.vGeom.obj3d,t=new Array,o=0;o<e.length;o++)"codeMade"==e[o].name&&e[o].slctItem&&t.push(e[o]);return t},TR3.redrawInfo=function(e,t,o,a){var n=TR3.getCoordsByXYmod(e,o),r=n[0],i=n[1],s=n[2],l=0,c=TR3.formatMeasure(TR3.tPixMesh);a&&(l=a-s),TR3.XYZ2Clip=[Math.round(1e3*r)/1e3,Math.round(1e3*i)/1e3,Math.round(100*s)/100];var T="<b>Project: "+proj4.Proj(TR3.srsImg).projName+" - Datum:"+proj4.Proj(TR3.srsImg).title+"</b><br><b>X:</b> "+TR3.XYZ2Clip[0]+"<br><b>Y:</b> "+TR3.XYZ2Clip[1]+"<br><b>Z:</b> "+TR3.XYZ2Clip[2]+"&nbsp;&nbsp;&nbsp;<b>±Zcur:</b> "+Math.round(100*l)/100+" m&nbsp;&nbsp;&nbsp;<b>Malla:</b> "+c[0]+" "+c[1];document.getElementById("infoGeo3d").innerHTML=T},TR3.keyDown=function(evt){1==TR3.moving&&("37"!=evt.keyCode&&"38"!=evt.keyCode&&"39"!=evt.keyCode&&"40"!=evt.keyCode||(TR3.moveKey.is=!0)),TR3.cursor.setkCde=evt.keyCode;var setZterr=eval(document.getElementById("setZ").value);if(Number.isInteger(setZterr)&&18==evt.keyCode&&(TR3.cursor.setZterr=setZterr),Number.isInteger(setZterr)&&16==evt.keyCode&&(TR3.cursor.setZterr=setZterr),TR3.transformControls.enabled)switch(evt.keyCode){case 81:TR3.transformControls.setSpace("local"===TR3.transformControls.space?"world":"local");break;case 17:TR3.transformControls.setTranslationSnap(100),TR3.transformControls.setRotationSnap(THREE.Math.degToRad(15));break;case 87:TR3.transformControls.setMode("translate");break;case 69:TR3.transformControls.setMode("rotate");break;case 82:TR3.transformControls.setMode("scale");break;case 187:case 107:TR3.transformControls.setSize(TR3.transformControls.size+.1);break;case 189:case 109:TR3.transformControls.setSize(Math.max(transformControls.size-.1,.1));break;case 88:TR3.transformControls.showX=!TR3.transformControls.showX;break;case 89:TR3.transformControls.showY=!TR3.transformControls.showY;break;case 90:TR3.transformControls.showZ=!TR3.transformControls.showZ;break;case 32:TR3.transformControls.enabled=!TR3.transformControls.enabled;break;case 70:var obj3d=TR3.transformControls.object;obj3d.wireframe=!obj3d.wireframe,obj3d.wireframe?obj3d.traverse(function(e){if(e.isMesh){var t=e.geometry,o=new THREE.WireframeGeometry(t),a=new THREE.LineBasicMaterial({color:13421772}),n=new THREE.LineSegments(o,a);n.name="wireframe",e.add(n)}}):obj3d.traverse(function(e){"wireframe"==e.name&&e.parent.remove(e)});break;case 32:TR3.transformControls.enabled=!TR3.transformControls.enabled;break;case 86:var obj3d=TR3.transformControls.object;obj3d.visible=!obj3d.visible}switch(evt.keyCode){case 46:TR3.del3dObj()}if(1==TR3.camera.visible&&"17"==evt.keyCode){var randomColor=Math.round(16777215*Math.random()),plasmaBall=new THREE.Mesh(new THREE.BoxGeometry(.12,.12,1),new THREE.MeshBasicMaterial({color:randomColor})),emitterPos=new THREE.Vector3(1,-1,0).unproject(TR3.camera);plasmaBall.position.copy(emitterPos),plasmaBall.quaternion.copy(TR3.camera.quaternion),TR3.scene.add(plasmaBall),TR3.plasmaBalls.push(plasmaBall)}if("16"==evt.keyCode&&(TR3.camera.visible=!TR3.camera.visible,0==TR3.camera.visible)){for(var i=0;i<TR3.plasmaBalls.length;i++)TR3.scene.remove(TR3.plasmaBalls[i]);TR3.plasmaBalls=[]}},TR3.keyUp=function(e){if(TR3.moveKey.is=!1,18==e.keyCode&&(TR3.cursor.setZterr=!1),16==e.keyCode&&(TR3.cursor.setZterr=!1),TR3.transformControls.enabled)switch(e.keyCode){case 17:TR3.transformControls.setTranslationSnap(null),TR3.transformControls.setRotationSnap(null)}},TR3.zCursor=function(e){var t=TR3.cursor.helper.position,o=TR3.zM2T(t.y)+e*TR3.getSizePix(),a=TR3.zM2T(o,!0);t.set(t.x,a,t.z),TR3.redrawInfo(t.x,t.y,t.z,o),TR3.vGeom.drawVector={x:t.x,y:a,z:t.z},TR3.optionsSet.cursor3d=!1,setTimeout(function(){TR3.optionsSet.cursor3d=!0},3e3)},TR3.click_Obj3d=function(e){document.getElementById("autoRotate").checked=!1,TR3.setOpts();var t=TR3.getSelectableObj();if(0<t.length){var o=TR3.getIntersect(e,t);if(o)return TR3.intersectEvClick(o),!0}TR3.sourceFile&&1==TR3.controls.active&&0==TR3.transformControls.active&&TR3.loadFile({slctItem:!0,mouseEvt:e}),0==TR3.transformControls.active&&TR3.transCtrlsEnabled(!1),TR3.transformControls.active=!1},TR3.setCoods2clip=function(e){if(e.preventDefault(),TR3.XYZ2Clip){var t=document.getElementById("setZ");t.value=TR3.XYZ2Clip.toString(),t.select(),document.execCommand("copy")}},TR3.updateVgeom=function(){var e=TR3.vGeom.drawVector,t=TR3.vGeom.item[TR3.vGeom.item.length-1],o=t.nPoint,a=TR3.vGeom.positions;if(a[3*o-3]=e.x,a[3*o-2]=e.y,a[3*o-1]=e.z,t.geometry.attributes.position.needsUpdate=!0,1<o&&TR3.vGeom.measure){for(var n=TR3.getMetrics(t),r=0;r<n.length;r++){var i=n[r][1]||e;i.inv=!0;var s={text:n[r][0],pos:i},l=TR3.makeTextSprite(s);TR3.scene.add(l)}TR3.MeasureEvEnd(n,l)}},TR3.addPoint=function(){if(TR3.cursor.helper.visible&&TR3.vGeom.positions&&-1!=TR3.newDraw){var e=TR3.vGeom.drawVector,t=TR3.vGeom.item[TR3.vGeom.item.length-1],o=t.nPoint,a=TR3.vGeom.positions;a[3*o+0]=e.x,a[3*o+1]=e.y,a[3*o+2]=e.z,t.nPoint++,t.geometry.setDrawRange(0,t.nPoint),TR3.updateVgeom()}},TR3.newVgeom=function(e){TR3.newDraw++;var t=new THREE.BufferGeometry,o=new Float32Array(450);t.setAttribute("position",new THREE.BufferAttribute(o,3)),TR3.vGeom.positions=o;var a,n=new THREE.LineBasicMaterial({color:new THREE.Color($("#PickDrawStereo").val())});if((a=1==TR3.vGeom.polig?new THREE.LineLoop(t,n):(TR3.distAlt=0,TR3.dist2D=0,TR3.dist3D=0,TR3.distTerr=0,new THREE.Line(t,n))).frustumCulled=!1,a.nPoint=0,a.magni=TR3.valuesSet.magnification,a.name="handMade",TR3.scene.add(a),TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var r=0;r<TR3.vGeom.sprites.length;r++)1==TR3.vGeom.sprites[r].reload&&(TR3.vGeom.sprites[r].reload=!1);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(r=0;r<TR3.vGeom.item.length;r++)1==TR3.vGeom.item[r].reload&&(TR3.vGeom.item[r].reload=!1);TR3.vGeom.item||(TR3.vGeom.item=new Array(0)),TR3.vGeom.item.push(a),TR3.vGeom.item[0].reload=!1},TR3.endDraw=function(e){TR3.newDraw=-1},TR3.getMetrics=function(e){var t,o=new Array;if(o.length=0,TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var a=0;a<TR3.vGeom.sprites.length;a++)1==TR3.vGeom.sprites[a].reload&&(TR3.scene.remove(TR3.vGeom.sprites[a]),TR3.vGeom.sprites.splice(a,1),a--);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(a=0;a<TR3.vGeom.item.length;a++)1==TR3.vGeom.item[a].reload&&(TR3.scene.remove(TR3.vGeom.item[a]),TR3.vGeom.item.splice(a,1),a--);if(1==TR3.vGeom.polig&&2<e.nPoint){t=e.geometry.getAttribute("position");var n=new Array;for(a=e.nPoint-1;-1<a;a--){var r=TR3.getCoordsByXYmod(t.getX(a),t.getZ(a));n.unshift(r)}var i=TR3.getSurf(n,e);o.push([TR3.txtMetric([i[0],i[1],i[2]]),new THREE.Vector3(t.getX(0),t.getY(0),t.getZ(0))]),o.push([TR3.txtMetric([i[6]]),new THREE.Vector3(t.getX(1),t.getY(1),t.getZ(1))]),o.push([TR3.txtMetric([i[3],i[4],i[5]])])}if(!TR3.vGeom.polig||0==TR3.vGeom.polig){t=e.geometry.getAttribute("position");var s=TR3.getCoordsByXYmod(t.getX(e.nPoint-1),t.getZ(e.nPoint-1)),l=TR3.getCoordsByXYmod(t.getX(e.nPoint-2),t.getZ(e.nPoint-2)),c=TR3.getDist(l[0],l[1],l[2],s[0],s[1],s[2]);o.push([TR3.txtMetric(c)])}return o},TR3.txtMetric=function(e){for(var t="",o=0;o<e.length;o++)e[o]?t+=" "+e[o].name+": "+e[o].val+" "+e[o].unit+"\n":(e.splice(o,1),o--);return t&&2<t.length&&(t=t.slice(0,-2)),t},TR3.assignZgeometries=function(){for(var e=0;e<TR3.vGeom.item.length;e++){var t=TR3.vGeom.item[e];if(t.geometry.vertices){for(var o=t.geometry.vertices,a=0;a<o.length;a++)o[a].y=o[a].y/TR3.vGeom.item[e].magni*TR3.valuesSet.magnification;t.geometry.verticesNeedUpdate=!0}else{var n=t.geometry.getAttribute("position");for(a=0;a<=TR3.vGeom.item[e].nPoint;a++)n.setY(a,n.getY(a)/TR3.vGeom.item[e].magni*TR3.valuesSet.magnification);n.needsUpdate=!0}t.magni=TR3.valuesSet.magnification,t.geometry.computeVertexNormals()}},TR3.makeTextSprite=function(e){void 0===e&&(e={});var t=!!e.hasOwnProperty("center")&&e.center,o=e.hasOwnProperty("pos")?e.pos:{x:44e4,y:444e4,z:900,inv:!1},a=e.hasOwnProperty("text")?e.text:"",n=!!e.hasOwnProperty("isPixSize")&&e.isPixSize;void 0===e.font&&(e.font={});var r=e.font.hasOwnProperty("fontFace")?e.font.fontFace:"Arial",i=e.font.hasOwnProperty("fontSize")?e.font.fontSize:24,s=!e.font.hasOwnProperty("bold")||e.font.bold;void 0===e.canvas&&(e.canvas={});var l=e.canvas.hasOwnProperty("textColor")?e.canvas.textColor:{r:0,g:0,b:0,a:1},c=e.font.hasOwnProperty("backgroundColor")?e.font.backgroundColor:{r:255,g:100,b:100,a:.8},T=e.canvas.hasOwnProperty("borderThickness")?e.canvas.borderThickness:4,d=e.canvas.hasOwnProperty("rounded")?e.canvas.rounded:6,R=e.canvas.hasOwnProperty("borderColor")?e.canvas.borderColor:{r:255,g:0,b:0,a:1},m=!!e.canvas.hasOwnProperty("text_Height")&&e.canvas.text_Height,u=!!e.canvas.hasOwnProperty("text_Width")&&e.canvas.text_Width,p=!!e.canvas.hasOwnProperty("scale")&&e.canvas.scale,g=document.createElement("canvas"),v=g.getContext("2d"),h="";s&&(h="Bold "),v.font=h+i+"px "+r,v.fillStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")",v.strokeStyle="rgba("+R.r+","+R.g+","+R.b+","+R.a+")",null==a&&(a="");var f=(a=a.replace(new RegExp("---","g")," ")).split("\n");f.length<=1&&(f=a.split("+++"));var y=f.length,b=i+T,M=m||(1.2*i+T)*y,E=v.measureText(a),w=u||E.width/y*1.2;146<M&&(M=146),292<w&&(w=292),v.lineWidth=T,TR3.roundRect(v,T/2,T/2,w+T,M,d),v.fillStyle="rgba("+l.r+","+l.g+","+l.b+","+l.a+")";for(var x=0;x<y;++x)v.fillText(f[x],T,b*(x+1));var S=new THREE.Texture(g);S.needsUpdate=!0;var C=new THREE.SpriteMaterial({map:S}),k=new THREE.Sprite(C);k.reload=!0;var D=new THREE.Vector3;if(o.inv)D.x=o.x,D.y=o.y,D.z=o.z;else{var I=TR3.coordM2T(o.x,o.y,o.z,!0);D.x=I[0],D.y=I[1],D.z=I[2]}n&&(D.y=TR3.zM2T(TR3.pix2geo(o.z),!0)-TR3.zM2T(0,!0)+4),k.position.set(D.x,D.y,D.z);var G=TR3.config.spritesDskMvl;p?n?k.scale.set(p*TR3.getSizePix()*G,p/2*TR3.getSizePix()*G,1):k.scale.set(p,p/2,1):k.scale.set(100*TR3.getSizePix()*G,50*TR3.getSizePix()*G,1);var H=TR3.rectaValue(1,.7,4,.05,y);return t?k.center.set(.9-H,.5):k.center.set(0,H),TR3.vGeom.sprites||(TR3.vGeom.sprites=new Array(0)),TR3.vGeom.sprites.push(k),k},TR3.del_vGeom=function(){if(TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var e=0;e<TR3.vGeom.sprites.length;e++)TR3.scene.remove(TR3.vGeom.sprites[e]);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(e=0;e<TR3.vGeom.item.length;e++)TR3.scene.remove(TR3.vGeom.item[e]);if(TR3.vGeom.obj3d&&TR3.vGeom.obj3d.length)for(e=0;e<TR3.vGeom.obj3d.length;e++)if(1!=TR3.vGeom.obj3d[e].persist2Scene){var t,o=TR3.vGeom.obj3d[e];t=o.scene?o.scene:o.parent&&o.parent.scene?o.parent.scene:o,TR3.scene.remove(t),TR3.vGeom.obj3d.splice(e,1),e--}TR3.newDraw=-1,TR3.vGeom.item=[],TR3.vGeom.sprites=!1,TR3.vGeom.item.magni,TR3.vGeom.item.nPoint=0},TR3.roundRect=function(e,t,o,a,n,r){e.beginPath(),e.moveTo(t+r,o),e.lineTo(t+a-r,o),e.quadraticCurveTo(t+a,o,t+a,o+r),e.lineTo(t+a,o+n-r),e.quadraticCurveTo(t+a,o+n,t+a-r,o+n),e.lineTo(t+r,o+n),e.quadraticCurveTo(t,o+n,t,o+n-r),e.lineTo(t,o+r),e.quadraticCurveTo(t,o,t+r,o),e.closePath(),e.fill(),e.stroke()},TR3.txtObject=function(n,r,i,s,l){TR3.loaderFONT.load(TR3.config.src+"helvetiker_regular.typeface.json",function(e){var t=new THREE.TextGeometry(n,{font:e,size:i}),o=new THREE.MeshPhongMaterial({color:r}),a=new THREE.Mesh(t,o);a.name=n,a.position.set(s[0],s[1],s[2]),a.rotation.y=l,TR3.scene.add(a)})},TR3.getFeatFromOL=function(e){TR3.loadingDiv.style.display="block";for(var t=0;t<e.length;t++){for(var o,a=e[t].getGeometry(),n=a.layout,r=a.getType(),i=["Point","Line","LineString","Polygon","Circle"],s=0;s<i.length;s++)-1!=r.indexOf(i[s])&&(o=i[s]);if(n&&o){var l=n.length,c=new Array,T=new Array;if("Circle"==o){var d=a.getCenter(),R=a.getRadius();c=(T=TR3.getCoordsByXYmod(d[0],-d[1]))?new THREE.Vector4(T[3],T[4],T[5],R):new THREE.Vector4(d[0],TR3.zMed,-d[1],R)}else if("Point"==o){d=a.getCoordinates();c=(T=TR3.getCoordsByXYmod(d[0],-d[1]))?new THREE.Vector3(T[3],T[4],T[5]):new THREE.Vector3(d[0],TR3.zMed,-d[1])}else if(a.layout){d=a.getCoordinates().toString().split(",");for(var m=0;m<d.length;m+=l){if(2==l)T=(u=TR3.getCoordsByXYmod(d[m],-d[m+1]))?[u[3],u[4],u[5]]:[d[m],TR3.zMed,-d[m+1]];else if(0==d[m+2]){var u;T=(u=TR3.getCoordsByXYmod(d[m],-d[m+1]))?[u[3],u[4],u[5]]:[d[m],TR3.zMed,-d[m+1]]}else{var p=TR3.zM2T(d[m+2],!0);T=[d[m],p,-d[m+1]]}c.push(new THREE.Vector3(T[0],T[1],T[2]))}}var g=e[t].getStyle(),v=null;if(g&&g.stroke_){var h=g.getStroke().getColor();v=new THREE.Color(h[0]/255,h[1]/255,h[2]/255)}var f={color:v},y=TR3.makeVectFeat(c,o,f,{reload:!1});TR3.scene.add(y)}}TR3.loadingDiv.style.display="none",TR3.VectorEvEnd()},TR3.setFeatToOL=function(){var e=TR3.LyrFeatFromOri;new Array;if(TR3.scene)for(var t=0;t<TR3.vGeom.item.length;t++){var o=TR3.vGeom.item[t];if("handMade"==o.name){for(var a,n=new Array,r=o.geometry.getAttribute("position"),i=o.nPoint||r.version,s=0;s<i;s++)n.push([r.getX(s),-r.getZ(s),TR3.zM2T(r.getY(s))]);"LineLoop"==o.type?(a="Polygon",n.push([r.getX(0),-r.getZ(0),TR3.zM2T(r.getY(0))]),n=[n]):a="Point"==o.type?"Point":"LineString";var l=o.material.color,c=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(100, 100, 100, 0.2)"}),stroke:new ol.style.Stroke({color:[255*l.r,255*l.g,255*l.b,1],width:2})}),T=new ol.Feature({geometry:new ol.geom[a](n)});T.setStyle(c),e.getSource().addFeature(T)}}},TR3.extrude2Dfeature=function(e,t,o){for(var a=TR3.getCoordsByXYmod(o[0],o[1],!1,!0)||TR3.zM2T(TR3.zMed,!0),n=new THREE.Group,r=new THREE.PlaneBufferGeometry(1,1,e.length-1,1),i=r.getAttribute("position"),s=[],l=0;l<e.length;l++)e[l][0]=e[l][0]-o[0],e[l][1]=e[l][1]-o[1],i.setXYZ(l,e[l][0],a[4],-e[l][1]);for(l=0;l<e.length;l++){i.setXYZ(l+e.length,e[l][0],a[4]+3*t,-e[l][1]);var c=new THREE.Vector2(e[l][0],-e[l][1]);s.push(c)}i.needsUpdate=!0;var T=Math.round(16777215*Math.random()),d=new THREE.MeshBasicMaterial({color:T}),R=new THREE.MeshBasicMaterial({color:T,side:THREE.BackSide,transparent:!0,opacity:.5}),m=new THREE.Mesh(r,d),u=new THREE.EdgesGeometry(m.geometry),p=new THREE.LineBasicMaterial({color:13421772}),g=new THREE.LineSegments(u,p),v=new THREE.ShapeBufferGeometry(new THREE.Shape(s)),h=new THREE.Mesh(v,R),f=v.getAttribute("position");for(l=0;l<f.count;l++)f.setXYZ(l,f.getX(l),a[4]+3*t,f.getY(l));f.needsUpdate=!0,n.add(g),n.add(h),n.add(m),n.position.set(o[0],0,-o[1]),TR3.scene.add(n)},TR3.personViewFn=function(e){var t=e||TR3.moveKey.size;TR3.controls.enableDamping=!1,TR3.controls.maxPolarAngle=1/0,TR3.controls.enableKeys=!1;var o=TR3.getOptModCoordCam();o&&-1e7!=o[1]?(TR3.changeHeight(o[1]+t,!0,!0),TR3.cursor.helper.scale.set(.05,.05,.05)):(TR3.initPosCamera(!0),setTimeout(function(){TR3.personViewFn(t)},1500))},TR3.orbitalViewFn=function(){TR3.moveKey.walk=!1,TR3.controls.enableKeys=!1,TR3.controls.maxPolarAngle=Math.PI/2;var e=TR3.getIntersect();if(e[0]){var t=TR3.getCoordsByXYmod(e[0].point.x,e[0].point.z);t&&t[2]&&TR3.controls.target.set(t[3],t[4],t[5]),TR3.cursor.helper.scale.set(.5,.5,.5)}else TR3.initPosCamera(!0),setTimeout(function(){TR3.orbitalViewFn()},1500)},TR3.initPosCamera=function(e){TR3.moveKey.walk=!1,1==e?new TWEEN.Tween(TR3.camera.position).to(TR3.startPos,1e3).easing(TWEEN.Easing.Linear).on("update",function(e){TR3.mesh.rotation.z+=.007}).on("complete",function(e){TR3.mesh.rotation.z=0,TR3.controls.target.set(e.x,0,e.z),TR3.controls.update(),TR3.CameraMoveEvEnd()}).start():(TR3.camera.position.copy(TR3.camera.position.initPos),TR3.controls.update())},TR3.changeHeight=function(e,t,o){TR3.zeroParallax=e,TR3.moveKey.azOriAng=TR3.controls.getAzimuthalAngle(),1==o?new TWEEN.Tween(TR3.camera.position).to({y:e},1e3).easing(TWEEN.Easing.Linear).on("complete",function(e){TR3.controls.target.set(e.x+.01,e.y,e.z+.01),TR3.controls.update(),TR3.setAzAngle(TR3.moveKey.azOriAng),TR3.controls.enableKeys=!0,TR3.controls.enableDamping=!0,TR3.CameraMoveEvEnd()}).start():TR3.camera.position.y=e,1==t&&(TR3.controls.target.y=e,TR3.controls.update())},TR3.moveKeyFn=function(e){if(1==TR3.moveKey.walk){var t=e||TR3.moveKey.size,o=TR3.getOptModCoordCam();TR3.changeHeight(o[1]+t,!0,!1)}},TR3.getDist=function(e,t,o,a,n,r){var i,s,l,c,T=r-o;TR3.distAlt+=T,l=TR3.formatMeasure(TR3.distAlt);var d=TR3.getCoordsDistance([e,t],[a,n]);TR3.dist2D+=d,c=TR3.formatMeasure(TR3.dist2D),TR3.dist3D+=Math.sqrt(Math.pow(d,2)+Math.pow(T,2)),i=TR3.formatMeasure(TR3.dist3D);for(var R=TR3.setSegmentsByTerr(e,t,o,a,n,r,3),m=R[1],u=new Array,p=0;p<m.length;p++)u.push(new THREE.Vector3(m[p][0],m[p][1],m[p][2]));var g=TR3.makeVectFeat(u,"Line",{color:65280},{reload:!1});return TR3.scene.add(g),TR3.distTerr+=R[0],s=TR3.formatMeasure(TR3.distTerr),i={name:"Dist.3D",val:i[0],unit:i[1]},s={name:"Dist.terr",val:s[0],unit:s[1]},[c={name:"Dist.2D",val:c[0],unit:c[1]},i,s,l={name:"Dif.alt",val:l[0],unit:l[1]}]},TR3.getSurf=function(e,t){e.push(e[0]);for(var o=0,a=0,n=0,r=[],i=[],s=(e[0][3],e[0][4],e[0][5],0);s<e.length-1;s++){for(var l=e[s][0],c=e[s][1],T=e[s][2],d=e[s+1][0],R=e[s+1][1],m=e[s+1][2],u=TR3.setSegmentsByTerr(l,c,T,d,R,m,3),p=0;p<u[1].length-1;p++)r.push(new THREE.Vector3(u[1][p][0],u[1][p][1],u[1][p][2])),i.push(new THREE.Vector2(u[1][p][0],u[1][p][2]));n+=u[0];var g=m-T,v=TR3.getCoordsDistance([l,c],[d,R]);a+=v,o+=Math.sqrt(Math.pow(v,2)+Math.pow(g,2))}var h=THREE.ShapeUtils.triangulateShape(i,[]),f=(new THREE.BufferGeometry).setFromPoints(r),y=[];for(s=0;s<h.length;s++)y.push(h[s][0],h[s][1],h[s][2]);f.setIndex(y);var b={color:"#ffffff",side:THREE.DoubleSide,transparent:!0,opacity:.75},M=TR3.makeMeshFeat(f,"Basic",b,{reload:!0});TR3.scene.add(M);var E=t.geometry.getAttribute("position"),w=[],x=[],S=[];for(s=0;s<t.nPoint;s++){var C=TR3.coordM2T(E.getX(s),E.getY(s),E.getZ(s));w.push(new THREE.Vector2(C[0],C[1])),x.push(new THREE.Vector2(E.getX(s),E.getZ(s))),S.push(new THREE.Vector3(E.getX(s),E.getY(s),E.getZ(s)))}var k=TR3.formatMeasure(Math.abs(THREE.ShapeUtils.area(w)),"surf"),D=(h=THREE.ShapeUtils.triangulateShape(x,[]),f=(new THREE.BufferGeometry).setFromPoints(S),y=[],0),I=0,G=0;for(s=0;s<h.length;s++){f.setIndex(y.push(h[s][0],h[s][1],h[s][2]));E=f.getAttribute("position");var H=new THREE.Vector3(E.getX(0),E.getY(0),E.getZ(0)),P=new THREE.Vector3(E.getX(1),E.getY(1),E.getZ(1)),z=new THREE.Vector3(E.getX(2),E.getY(2),E.getZ(2)),O=new THREE.Triangle(H,P,z);D+=Math.abs(O.getArea());var B=TR3.makeSubTriangles([O],3),F=TR3.get3dMetrics(B,M.id);I+=F[0],G+=F[1]}var j=TR3.formatMeasure(D,"surf"),A=TR3.formatMeasure(I,"surf"),V=TR3.formatMeasure(G,"vol");return a=TR3.formatMeasure(a),o=TR3.formatMeasure(o),n=TR3.formatMeasure(n),[{name:"Per.2D",val:a[0],unit:a[1]},{name:"Per.3D",val:o[0],unit:o[1]},{name:"Per.terr",val:n[0],unit:n[1]},{name:"Surf.2D",val:k[0],unit:k[1]},{name:"Surf.3D",val:j[0],unit:j[1]},{name:"Surf.terr",val:A[0],unit:A[1]},G={name:"Vol.terr",val:V[0],unit:V[1]}]},TR3.makeSubTriangles=function(e,t){var o=t||1,a=TR3.tPixMesh*TR3.tPixMesh/2/o,n=0,r=new Array;for(n=0;n<e.length;n++){var i=e[n],s=new THREE.Vector3((i.a.x+i.b.x+i.c.x)/3,(i.a.y+i.b.y+i.c.y)/3,(i.a.z+i.b.z+i.c.z)/3),l=new Array;l.push(i.a,i.b,i.c,i.a);for(var c=0;c<l.length-1;c++){var T=s,d=l[c],R=l[c+1],m=new THREE.Vector3((d.x+R.x)/2,(d.y+R.y)/2,(d.z+R.z)/2),u=new THREE.Triangle(T,m,d);r.push(u);var p=new THREE.Triangle(T,m,R);r.push(p)}}return Math.abs(r[0].getArea())>a?TR3.makeSubTriangles(r,o):r},TR3.get3dMetrics=function(e,t){for(var o=0,a=0,n=new THREE.Group,r=0;r<e.length;r++){var i=[],s=TR3.getCoordsByXYmod(e[r].a.x,e[r].a.z);i.push(new THREE.Vector3(s[3],s[4],s[5]));s=TR3.getCoordsByXYmod(e[r].b.x,e[r].b.z);i.push(new THREE.Vector3(s[3],s[4],s[5]));s=TR3.getCoordsByXYmod(e[r].c.x,e[r].c.z);i.push(new THREE.Vector3(s[3],s[4],s[5]));var l=(new THREE.BufferGeometry).setFromPoints(i),c={color:"#00ff00",side:THREE.DoubleSide,wireframe:!0},T=TR3.makeMeshFeat(l,"Basic",c,{reload:!0});n.add(T);var d=new THREE.Triangle(i[0],i[1],i[2]),R=Math.abs(d.getArea());o+=R;var m=[];m.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),m.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),m.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z));var u=new THREE.Triangle(m[0],m[1],m[2]),p=(Math.abs(u.getArea())+R)/2,g=new THREE.Vector3((e[r].a.x+e[r].b.x+e[r].c.x)/3,(e[r].a.y+e[r].b.y+e[r].c.y)/3,(e[r].a.z+e[r].b.z+e[r].c.z)/3),v=TR3.zM2T(g.y),h=TR3.scene.getObjectById(t);a+=p*(v-TR3.getCoordsByXYmod(g.x,g.z,h)[2])}return TR3.scene.add(n),[o,a]},TR3.setSegmentsByTerr=function(e,t,o,a,n,r,i,s){var l,c=new Array,T=new Array;if(1==s){var d=TR3.coordM2T(e,t,o);e=d[0],t=d[1],o=d[2];var R=TR3.coordM2T(a,n,r);a=R[0],n=R[1],r=R[2]}for(var m=Math.ceil(Math.abs((a-e)/TR3.tPixMesh)),u=Math.ceil(Math.abs((n-t)/TR3.tPixMesh)),p=Math.max(m,u)*i,g=0,v=(a-e)/p,h=(n-t)/p,f=0;f<p;f++){var y=e+v*f,b=t+h*f,M=TR3.getCoordsByXYmod(y,-b);c.push([M[3],M[4],M[5]]),T.push([M[0],M[1],M[2]]);var E=e+v*(f+1),w=t+h*(f+1),x=(l=TR3.getCoordsByXYmod(E,-w))[2]-M[2],S=TR3.getCoordsDistance([M[0],M[1]],[l[0],l[1]]);g+=Math.sqrt(Math.pow(S,2)+Math.pow(x,2))}return null!=l&&(c.push([l[3],l[4],l[5]]),T.push([l[0],l[1],l[2]])),[g,c,T]},TR3.getCoordsDistance=function(e,t){var o;if("undefined"!=typeof ol){var a="EPSG:4326",n=TR3.srsImg,r=ol.proj.transform(e,n,a),i=ol.proj.transform(t,n,a);o=ol.sphere.getDistance(r,i)}else if("undefined"!=typeof L){r=L.latLng(proj4(proj4.defs(TR3.srsImg),proj4.defs("EPSG:4326"),e)),i=L.latLng(proj4(proj4.defs(TR3.srsImg),proj4.defs("EPSG:4326"),t));o=r.distanceTo(i)}else o=Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));return o},TR3.getCoordsDistance3D=function(e,t){var o=t[2]-e[2],a=TR3.getCoordsDistance([e[0],e[1]],[t[0],t[1]]);return Math.sqrt(Math.pow(a,2)+Math.pow(o,2))},TR3.formatMeasure=function(e,t){var o;return o="surf"==t?1e6<Math.abs(e)?(e=Math.round(e/1e6*1e3)/1e3,"km2"):(e=Math.round(100*e)/100,"m2"):"vol"==t?1e9<Math.abs(e)?(e=Math.round(e/1e9*1e3)/1e3,"km3"):(e=Math.round(100*e)/100,"m3"):1e3<Math.abs(e)?(e=Math.round(e/1e3*1e3)/1e3,"km"):(e=Math.round(100*e)/100,"m"),[e,o]},TR3.makeApilator=function(e,t,o,a){var n=e.scene,r=new THREE.Vector3;(new THREE.Box3).setFromObject(n).getSize(r);var i=r.y,s=n.position;if(100==o){var l=2*Math.PI/8,c=s.x,T=1*s.z-70;for(m=0;m<=7;m++)if(6!=m){var d=new THREE.Vector3(c+70*Math.cos(l*m),s.y,T-70*Math.sin(l*m)),R=TR3.makeClon(e,n,d,t,a);TR3.scene.add(R)}}else for(var m=0;m<o-1;m++){d=new THREE.Vector3(s.x,s.y+i*(m+1),s.z),R=TR3.makeClon(e,n,d,t,a);TR3.scene.add(R)}},TR3.makeMultiPos=function(e,t,o,a){for(var n=e.scene,r=1;r<t.length;r++){var i,s=t[r];i="object"==typeof o?o[r]:o;var l=TR3.coordM2T(s[0],s[1],s[2],!0),c=new THREE.Vector3;c.x=l[0],c.y=l[1],c.z=l[2];var T=TR3.makeClon(e,n,c,i,a,s);TR3.scene.add(T)}},TR3.makeClon=function(e,t,o,a,n,r){var i=t.clone(),s=new Array;Object.assign(s,e);i.name="codeMade",i.position.set(o.x,o.y,o.z),a&&"object"==typeof a&&(i.children[0].scale.x=a[0],i.children[0].scale.y=a[2],i.children[0].scale.z=a[1],s.scaleByCode=a),0<s.animations.length&&n&&(s.mixer=new THREE.AnimationMixer(i),s.mixer.clipAction(s.animations[0]).play());return s.scene=i,s.looking=r,s.zPos=o.y,TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),TR3.vGeom.obj3d.push(s),i},TR3.handleFileSelect=function(e,t){if(TR3.sourceFile=!1,e.target.files){var o=e.target.files[0],a=escape(o.name);document.getElementById(e.target.id+"_fake").value=a,TR3.sourceFile=(window.URL||window.webkitURL).createObjectURL(o)}else alert("Acción no soportada por su navegador, actualicese o utilice algún otro")},TR3.loadFile=function(t){var o=$.Deferred();void 0===t&&(t={});var e,a,n=!!t.hasOwnProperty("src")&&t.src,r=document.getElementById("size3dObj");r.innerHTML="";document.getElementById("file_3d_fake").value;return n?(a=n.split(".")[1],e=n):(a=document.getElementById("file_3d_fake").value.split(".")[1],e=TR3.sourceFile,t.slctItem=!0,t.persist2Scene=!0),e&&"glb"==a&&TR3.loaderGLTF.load(e,function(e){TR3.loaderGLTFsucces(e,o,t)},function(e){r.innerHTML=Math.round(e.loaded/e.total*100)+"% loaded"},function(e){r.innerHTML="error: "+e.message,console.log(e),TR3.unlock3d("obj3d")}),e&&"ifc"==a&&TR3.loaderIFC.load(e,function(e){TR3.loaderGLTFsucces(e,o,t)},function(e){r.innerHTML=Math.round(e.loaded/e.total*100)+"% loaded"},function(e){r.innerHTML="error: "+e.message,console.log(e),TR3.unlock3d("obj3d")}),o.promise()},TR3.loaderGLTFsucces=function(e,t,o){void 0===o&&(o={});var a=!!o.hasOwnProperty("pos")&&o.pos,n=!o.hasOwnProperty("animation")||o.animation,r=!!o.hasOwnProperty("scale")&&o.scale,i=!!o.hasOwnProperty("aRotate")&&o.aRotate,s=(!o.hasOwnProperty("transform")||o.transform,!!o.hasOwnProperty("apilator")&&o.apilator),l=!!o.hasOwnProperty("slctItem")&&o.slctItem,c=!!o.hasOwnProperty("isPixSize")&&o.isPixSize,T=!!o.hasOwnProperty("href")&&o.href,d=!!o.hasOwnProperty("isFloor")&&o.isFloor,R=!!o.hasOwnProperty("mouseEvt")&&o.mouseEvt,m=!!o.hasOwnProperty("persist2Scene")&&o.persist2Scene;e.persist2Scene=m;var u=e.scene||e;e.animations&&0<e.animations.length&&n&&(e.mixer=new THREE.AnimationMixer(u),e.mixer.clipAction(e.animations[0]).play());var p=new THREE.Vector3;if("object"==typeof a[0]){var g=TR3.coordM2T(a[0][0],a[0][1],a[0][2],!0);p.x=g[0],p.y=g[1],p.z=g[2],e.looking=a[0]}else if(a){g=TR3.coordM2T(a[0],a[1],a[2],!0);p.x=g[0],p.y=g[1],p.z=g[2]}else{var v=TR3.getIntersect(R);if(0<v.length){var h=v[0];p.x=h.point.x,p.y=h.point.y,p.z=h.point.z}else p.x=TR3.mesh.position.x,p.y=TR3.zMed+(TR3.zMax-TR3.zMin)/3,p.z=TR3.mesh.position.z}e.zPos=p.y;var f=[1,1,1];if(e.scaleByCode=f,r){if(f="object"==typeof r[0]?JSON.parse(JSON.stringify(r[0])):JSON.parse(JSON.stringify(r)),c){var y=new THREE.Vector3;(new THREE.Box3).setFromObject(u).getSize(y),f[0]=TR3.pix2geo(f[0])/y.x,f[1]=TR3.pix2geo(f[1])/y.z,f[2]=TR3.pix2geo(f[2])/y.y}u.children[0].scale.x=f[0],u.children[0].scale.y=f[2],u.children[0].scale.z=f[1],e.scaleByCode=f}else e.scaleByCode=[u.children[0].scale.x,u.children[0].scale.y,u.children[0].scale.z];i&&("boolean"==typeof i?e.autoRotation=i:u.rotation.y=i),d&&(e.isFloor=d),T&&(e.href=T),l&&(e.slctItem=l),u.position.set(p.x,p.y,p.z),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),TR3.vGeom.obj3d.push(e),e.name="codeMade",TR3.sourceFile?(TR3.scene.add(u),TR3.transCtrlsEnabled(!0),TR3.transformControls.attach(u)):(TR3.sourceFile="",document.getElementById("file_3d_fake").value="Explorar GLB/IFC..."),s&&!isNaN(s)&&TR3.makeApilator(e,r,s,n),"object"==typeof a[0]&&TR3.makeMultiPos(e,a,r,n),t.resolve(u)},TR3.del3dObj=function(){var e=TR3.vGeom.obj3d;if(TR3.vGeom&&e&&0<e.length){var t;if(TR3.transformControls.enabled){var o=TR3.transformControls.object;TR3.transCtrlsEnabled(!1);for(var a=0;a<e.length;a++){var n;n=e[a].scene?e[a].scene.uuid:e[a].uuid,o.uuid==n&&(t=a)}}if(t=t||e.length-1,TR3.vGeom&&e&&0<e.length)(o=e[t]).scene?TR3.scene.remove(o.scene):TR3.scene.remove(o),e.splice(t,1)}},TR3.transCtrlsEnabled=function(e){e?TR3.lock3d("obj3d"):TR3.unlock3d("obj3d"),TR3.transformControls.enabled=e,TR3.transformControls.showX=e,TR3.transformControls.showY=e,TR3.transformControls.showZ=e,document.getElementById("size3dObj").innerHTML=""},TR3.getSizeObj=function(e){var t=new THREE.Vector3;return(new THREE.Box3).setFromObject(e).getSize(t),[TR3.formatMeasure(t.x),TR3.formatMeasure(t.y),TR3.formatMeasure(t.z)]},TR3.requestDTMwcs=!1,TR3.scene,TR3.renderer,TR3.camera,TR3.controls,TR3.mesh,TR3.fov=30,TR3.sourceFile=!1,TR3.starField,TR3.geo2UTM,TR3.bboxImgOri=[],TR3.srsImg,TR3.widthImg,TR3.heightImg,TR3.tPixImg,TR3.texture,TR3.maxResolMesh=5,TR3.zMin,TR3.zMed,TR3.zMax,TR3.arrayZ=[],TR3.zone=[],TR3.reducMeshW,TR3.reducMeshH,TR3.map,TR3.canvasDest,TR3.loadingDiv,TR3.canvasDestW,TR3.canvasDestH,TR3.optionsSet={imgControl:!0,cursor3d:!1,anaglyph:!1,autoRotate:!1,wireframeMesh:!1,tentative:!0,cheapMode:!1},TR3.valuesSet={magnification:"auto",height:0},TR3.cursor={helper:!1,setZterr:!1,setkCde:!1,causeLock:""},TR3.newMeshMap=1,TR3.oneMeshMap=1,TR3.idAnimation=-1,TR3.zeroParallax,TR3.moveKey={is:!1,size:1.7,walk:!1,azOriAng:0},TR3.startPos,TR3.lookAt,TR3.viewScenes=!0,TR3.plasmaBalls=new Array,TR3.newDraw=-1,TR3.vGeom=[],TR3.vGeom.drawVector,TR3.vGeom.positions,TR3.vGeom.sprites=[],TR3.vGeom.measure=!1,TR3.vGeom.polig=!1,TR3.vGeom.item=[],TR3.vGeom.item.magni,TR3.vGeom.item.nPoint=0,TR3.vGeom.obj3d=!1,TR3.sprite=!0,TR3.featFromOri,TR3.animate=function(){TR3.idAnimation=requestAnimationFrame(TR3.animate),TR3.controls.update(),TR3.renderScene(),1==TR3.moveKey.is&&TR3.moveKeyFn();var e=TR3.optionsSet.cheapMode;0==e&&(TR3.starField.rotation.y+=5e-4,TR3.starField.rotation.x+=5e-4);var t=TR3.clock.getDelta();if(0==e&&TR3.vGeom&&TR3.vGeom.obj3d)for(var o=0;o<TR3.vGeom.obj3d.length;o++){TR3.vGeom.obj3d[o].mixer&&TR3.vGeom.obj3d[o].mixer.update(t);var a=TR3.vGeom.obj3d[o].autoRotation;a&&("boolean"==typeof a?TR3.vGeom.obj3d[o].scene.rotation.y+=.01:(TR3.vGeom.obj3d[o].scene.children[0].rotation.y+=a,a=!1)),!0}if(0==e&&0<TR3.plasmaBalls.length&&1==TR3.camera.visible)for(o=0;o<TR3.plasmaBalls.length;o++)TR3.plasmaBalls[o].translateZ(-100*t);var n=.02*TR3.clock.getElapsedTime(),r=TR3.zone;if(0==e&&TR3.moon&&TR3.moon.position.set(15e5*Math.cos(n)+(r[2]+r[0])/2,7e5*Math.sin(n)-2e5,15e5*Math.sin(n)+-(r[3]+r[1])/2),0==e){var i=TR3.scene.getObjectByName("Sky"),s=i.material.uniforms.rayleigh.value,l=Math.round(10*TR3.oscillator(.4+n,1,.3,0,.4))/10;Math.round(200*n)%9==0&&s!=l&&(i.material.uniforms.rayleigh.value=l)}},TR3.startAnimation=function(e){TR3.idAnimation=window.requestAnimationFrame(TR3.animate)},TR3.stopAnimation=function(e){window.cancelAnimationFrame(TR3.idAnimation)},TR3.renderScene=function(){TWEEN.update(),TR3.optionsSet.anaglyph&&Detector.webgl?TR3.anaglyphRenderer.render(TR3.scene,TR3.camera,TR3.zeroParallax):TR3.renderer.render(TR3.scene,TR3.camera)},TR3.exportGLTF=function(e){var t=new Array;if("scene"==e){if(TR3.vGeom.item&&0<TR3.vGeom.item.length)for(i=0;i<TR3.vGeom.item.length;i++){"BufferGeometry"==TR3.vGeom.item[i].geometry.type&&t.push(TR3.vGeom.item[i])}if(TR3.vGeom.obj3d&&0<TR3.vGeom.obj3d.length)for(i=0;i<TR3.vGeom.obj3d.length;i++)t.push(n(TR3.vGeom.obj3d[i]));t.push(TR3.mesh)}else if("obj3d"==e){if(TR3.vGeom.obj3d&&0<TR3.vGeom.obj3d.length)for(i=0;i<TR3.vGeom.obj3d.length;i++)t.push(n(TR3.vGeom.obj3d[i]))}else if("items"!=e||TR3.config.unic)t=TR3.mesh;else if(IIIkel.util.vectorDraw.prototype.exportLyr(TR3.LyrFeatFromOri.getSource().getFeatures()),TR3.vGeom.item&&0<TR3.vGeom.item.length)for(i=0;i<TR3.vGeom.item.length;i++){"BufferGeometry"==TR3.vGeom.item[i].geometry.type&&t.push(TR3.vGeom.item[i])}(new GLTFExporter).parse(t,function(e){e instanceof ArrayBuffer?function(e,t){a(new Blob([e],{type:"application/octet-stream"}),t)}(e,"scene.glb"):function(e,t){a(new Blob([e],{type:"text/plain"}),t)}(JSON.stringify(e,null,2),"t3scene.gltf")},{});var o=document.createElement("a");function a(e,t){o.href=URL.createObjectURL(e),o.download=t,o.click()}function n(e){var t,o=(t="Scene"==e.type||"Group"==e.type?e:e.scene).children[0],a=TR3.SkeletonUtils.clone(o);if(e.scaleByCode)a.scale.x*=e.scaleByCode[0],a.scale.y*=e.scaleByCode[0],a.scale.z*=e.scaleByCode[0];else{var n=new THREE.Vector3;(new THREE.Box3).setFromObject(o).getSize(n);var r=new THREE.Vector3;(new THREE.Box3).setFromObject(a).getSize(r);n.x,n.y,n.z;a.scale.x=n.x/r.x,a.scale.y=n.y/r.y,a.scale.z=n.z/r.z}var i=t.position.clone(),s=a.position.clone();return a.position.set(i.x+s.x,i.y+s.y,i.z+s.z),a}o.style.display="none",document.body.appendChild(o)},TR3.clearMeshMap=function(e){var t=TR3.canvasDest,o=TR3.scene,a=TR3.renderer;if("evtOl"==e&&TR3.setFeatToOL(),t&&Detector.webgl){var n=function(e){e.dispose();for(var t=0,o=Object.keys(e);t<o.length;t++){var a=e[o[t]];a&&"object"==typeof a&&"minFilter"in a&&a.dispose()}};for(a.dispose(),o.traverse(function(e){if(e.isMesh)if(e.geometry.dispose(),e.material.isMaterial)n(e.material);else for(var t=0,o=e.material;t<o.length;t++){var a=o[t];n(a)}}),o.remove.apply(o,o.children);0<o.children.length;)o.remove(o.children[0]);TR3.canvasDest=null,t.remove()}else if(t&&Detector.canvas){t.getContext("2d").clearRect(0,0,t.width,t.height),t.remove()}t&&(TR3.stopAnimation(),TWEEN.removeAll()),TR3.del_vGeom()},TR3.intersectEvOver=function(e){var t=new CustomEvent("TR3-onIntersectEvOver",{detail:e});TR3.map.dispatchEvent(t)},TR3.intersectEvClick=function(e){var t=new CustomEvent("TR3-onIntersectEvClick",{detail:e});TR3.map.dispatchEvent(t)},TR3.CameraMoveEvEnd=function(e){e&&console.log(e);var t=new CustomEvent("TR3-onCameraMoveEnd",{detail:"an event"});TR3.map.dispatchEvent(t)},TR3.VectorEvEnd=function(e){e&&console.log(e);var t=new CustomEvent("TR3-onVectorEnd",{detail:"an event"});TR3.map.dispatchEvent(t)},TR3.MeasureEvEnd=function(e,t){var o=new CustomEvent("TR3-onMeasureEnd",{detail:[e,t]});TR3.map.dispatchEvent(o)},TR3.setMeshMap=function(imgOri,bboxImgOri,optionsSet,valuesSet){if(TR3.loadingDiv=document.getElementById("loadingTerrain"),document.getElementById("3doptions").style.display="none",TR3.bboxImgOri&&JSON.stringify(bboxImgOri)==JSON.stringify(TR3.bboxImgOri)&&TR3.loadingDiv&&TR3.canvasDest)TR3.setImageMesh(imgOri),document.getElementById("3doptions").style.display="block";else{var imgControl,cursor3d,anaglyph,magnification,autoRotate,wireframeMesh,tentative,cheapMode;if(TR3.newMeshMap=1,TR3.clearMeshMap(),TR3.bboxImgOri=[eval(bboxImgOri[0]),eval(bboxImgOri[1]),eval(bboxImgOri[2]),eval(bboxImgOri[3])],"longlat"===proj4.Proj(TR3.srsImg).projName?TR3.geo2UTM=4e7/360:TR3.geo2UTM=1,TR3.zone=[TR3.bboxImgOri[0]*TR3.geo2UTM,TR3.bboxImgOri[1]*TR3.geo2UTM,TR3.bboxImgOri[2]*TR3.geo2UTM,TR3.bboxImgOri[3]*TR3.geo2UTM],imgControl=optionsSet.imgControl,cursor3d=optionsSet.cursor3d,anaglyph=optionsSet.anaglyph,autoRotate=optionsSet.autoRotate,wireframeMesh=optionsSet.wireframeMesh,tentative=optionsSet.tentative,cheapMode=optionsSet.cheapMode,magnification=valuesSet.magnification,TR3.lookAt=valuesSet.lookAt,TR3.divContainer(),TR3.divLoading(),TR3.setMagniValues(magnification),TR3.setMeshZone(),TR3.canvasDest=TR3.cvsDesty(),Detector.canvas){if(Detector.webgl)TR3.renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,canvas:TR3.canvasDest,antialias:!0});else if(TR3.renderer=new THREE.CanvasRenderer({canvas:TR3.canvasDest}),!TR3.widthImg){var txtSupportWebgl="Su navegador parece no soportar WebGl. Por favor, actualice su versión o pruebe algún otro.";alert(txtSupportWebgl),pSupportWebgl=document.createElement("p"),pSupportWebgl.id="pSupportWebgl",pSupportWebgl.style.color="#ff0000",pSupportWebgl.innerHTML=txtSupportWebgl,document.getElementById("initDialog").appendChild(pSupportWebgl),document.getElementById("anaglyphCheck").style.display="none",document.getElementById("anaglyphType").style.display="none"}}else if(!TR3.widthImg){var txtSupportHTML5="Su navegador parece no soportar HTML5. Por favor, actualice su versión o pruebe algún otro.";alert(txtSupportHTML5),pSupportHTML5=document.createElement("p"),pSupportHTML5.id="pSupportHTML5",pSupportHTML5.style.color="#ff0000",pSupportHTML5.innerHTML=txtSupportHTML5,document.getElementById("initDialog").appendChild(pSupportHTML5),document.getElementById("OptionsDialog").style.display="none"}TR3.renderer.physicallyCorrectLights=!0,TR3.renderer.setSize(TR3.canvasDestW,TR3.canvasDestH),TR3.anaglyphRenderer=new TR3.AnaglyphEffect(TR3.renderer,0),TR3.anaglyphRenderer.setSize(TR3.canvasDestW,TR3.canvasDestH),TR3.scene=new THREE.Scene,TR3.clock=new THREE.Clock,TR3.loaderGLTF=new TR3.GLTFLoader,TR3.loaderIFC=new TR3.IFCLoader,TR3.loaderFONT=new THREE.FontLoader,TR3.sky=new TR3.Sky,TR3.sky.name="Sky",TR3.scene.add(TR3.sky),TR3.camera=new THREE.PerspectiveCamera(TR3.fov,TR3.canvasDestW/TR3.canvasDestH,1,5e6),TR3.scene.add(TR3.camera),TR3.camera.visible=!1;var hemispheric=new THREE.HemisphereLight(16777215,16777215,1.5);TR3.scene.add(hemispheric);var ambient=new THREE.AmbientLight(16777215,1.5),moves;TR3.scene.add(ambient);var imgOrbitalMoves=document.getElementById("imgOrbitalMoves");moves=imgControl?imgOrbitalMoves:TR3.canvasDest,TR3.controls=new TR3.OrbitControls(TR3.camera,moves),TR3.controls.listenToKeyEvents(window),TR3.controls.maxPolarAngle=Math.PI/2,TR3.controls.enableDamping=!0,TR3.controls.dampingFactor=.19,TR3.controls.screenSpacePanning=!1,TR3.controls.addEventListener("change",function(e){TR3.transCtrlsEnabled(!1),TR3.controls.active=!1}),TR3.controls.addEventListener("end",function(e){var t=setInterval(function(){TR3.controls.active&&clearInterval(t),TR3.controls.active=!0},500);TR3.setOpts({autoRotate:!1})}),TR3.transformControls=new TR3.TransformControls(TR3.camera,TR3.canvasDest),TR3.transformControls.enabled=!1,TR3.scene.add(TR3.transformControls),TR3.transformControls.addEventListener("dragging-changed",function(e){TR3.controls.enabled=!e.value;var t=TR3.transformControls,o=document.getElementById("size3dObj");if(t.enabled){var a=t.object;if(a&&a.parent){var n=TR3.getSizeObj(a);o.innerHTML="<b>X:</b>"+n[0][0]+n[0][1]+" <b>Y:</b>"+n[2]+n[2][1]+" <b>Z:</b>"+n[1][0]+n[1][1]}}}),TR3.transformControls.addEventListener("mouseDown",function(e){TR3.transformControls.active=!0}),TR3.makeSteve(),TR3.makeWorld(imgOri),TR3.persist2Scene(),TR3.setOptions(imgControl,cursor3d,anaglyph,autoRotate,wireframeMesh,tentative,cheapMode)}1==TR3.oneMeshMap&&(window.addEventListener("resize",TR3.onWindowResize,!1),TR3.map.addEventListener("mousemove",TR3.onIntersect,!1),TR3.map.addEventListener("contextmenu",TR3.setCoods2clip,!1),TR3.map.addEventListener("click",TR3.addPoint,!1),TR3.map.addEventListener("click",TR3.click_Obj3d,!1),TR3.map.addEventListener("touchstart",function(e){TR3.click_Obj3d(e)},!1),TR3.map.addEventListener("wheel",TR3.onMouseWheel,!1),window.addEventListener("keydown",TR3.keyDown,!1),window.addEventListener("keyup",TR3.keyUp,!1))},TR3.onMouseWheel=function(e){var t=Math.max(-1,Math.min(1,-e.wheelDelta||e.detail||e.deltaY));if(TR3.cursor.helper.visible&&TR3.zCursor(t),1==TR3.moveKey.walk){var o=t*TR3.controls.keyPanSpeed/5;TR3.controls.keyPanSpeed=TR3.controls.keyPanSpeed+o}if(1==TR3.optionsSet.anaglyph){var a=TR3.getIntersect();if(0<a.length){var n=TR3.camera.position;TR3.zeroParallax=n.distanceTo(a[0].point)}}},TR3.onWindowResize=function(){TR3.camera.aspect=TR3.canvasDestW/TR3.canvasDestH,TR3.camera.updateProjectionMatrix(),TR3.renderer.setSize(TR3.canvasDestW,TR3.canvasDestH)},TR3.onCompleteMap=function(){if(TR3.lookAt&&TR3.setLookAt(TR3.lookAt),TR3.config.unic||setTimeout(function(){TR3.setObj3d(),TR3.getFeatFromOL()},2e3),TR3.scene&&TR3.scene.children)for(var e=0;e<TR3.scene.children.length;e++)if("string"==typeof TR3.scene.children[e].position.y){var t,o=TR3.scene.children[e].position.y.replaceAll("$",""),a=o.slice(-1),n=o.slice(0,-1);t=o&&"T"==a?TR3.zM2T(1*n,!0):o.replace(a,""),TR3.scene.children[e].position.y=1*t}TR3.loadingDiv.style.display="none",TR3.dfd_setMap.resolve(TR3.mesh),document.getElementById("3doptions").style.display="block",TR3.newMeshMap=0,TR3.oneMeshMap=0},TR3.persist2Scene=function(){if(TR3.vGeom.obj3d)for(var e=0;e<TR3.vGeom.obj3d.length;e++){var t,o=TR3.vGeom.obj3d[e];1==o.persist2Scene&&(t=o.scene?o.scene:o.parent&&o.parent.scene?o.parent.scene:o,TR3.scene.add(t))}},TR3.lock3d=function(e){TR3.cursor.causeLock+=e,TR3.canvasDest.style.zIndex="9"},TR3.unlock3d=function(e){if(-1<TR3.cursor.causeLock.indexOf(e)){var t=TR3.cursor.causeLock.split(e);TR3.cursor.causeLock=t.toString().replace(/,/g,""),""==TR3.cursor.causeLock&&(TR3.canvasDest.style.zIndex="0")}},TR3.rectaValue=function(e,t,o,a,n){return(n-e)/(o-e)*(a-t)+t},TR3.rectaValue3D=function(e,t,o,a,n,r,i){return[i,TR3.rectaValue(e,t,a,n,i),TR3.rectaValue(e,o,a,r,i)]},TR3.geo2pix=function(e){return 1*e/(TR3.tPixImg*TR3.geo2UTM)},TR3.pix2geo=function(e){return e*(TR3.tPixImg*TR3.geo2UTM)},TR3.getSizePix=function(){return((TR3.bboxImgOri[2]-TR3.bboxImgOri[0])/TR3.widthImg+(TR3.bboxImgOri[3]-TR3.bboxImgOri[1])/TR3.heightImg)/2},TR3.setAzAngle=function(e){var t,o,a=TR3.controls.getAzimuthalAngle();t=e<=0?-e:2*Math.PI-e,o=a<=0?-a:2*Math.PI-a,t>2*Math.PI&&(t-=2*Math.PI),o>2*Math.PI&&(o-=2*Math.PI);var n=o-t;n=0<n?2*Math.PI-n:Math.abs(n),"function"==typeof TR3.controls.rotateLeft&&TR3.controls.rotateLeft(n)},TR3.getOptModCoordCam=function(){for(var e=TR3.camera.position,t=-1e7,o=new Array,a=2*TR3.getSizePix(),n=TR3.controls.getAzimuthalAngle(),r=e.x+a*Math.sin(n),i=e.z-a*Math.cos(n),s=0;s<TR3.vGeom.obj3d.length;s++){var l=TR3.vGeom.obj3d[s];if(l.isFloor&&1==l.isFloor){var c=TR3.getCoordsByXYmod(r,i,l);c&&o.push(c)}}o.push(TR3.getCoordsByXYmod(r,i));for(s=0;s<o.length;s++)o[s]&&t<o[s][4]&&(t=o[s][4]);return[e.x,t,e.z]},TR3.getCoordsByXYmod=function(e,t,o,a){var n=o||TR3.mesh;a&&(t=-t);var r,i=new THREE.Vector3(e,1e6,t),s=new THREE.Vector3(e,-1e6,t).sub(i),l=new THREE.Raycaster(i,s.clone().normalize());if((r=n.scene&&n.scene.children?l.intersectObject(n.scene.children[0],!0):l.intersectObject(n))[0]){var c,T,d,R,m,u,p=r[0].point;c=p.x,T=-p.z,d=TR3.zM2T(p.y,!1),R=p.x,m=p.y,u=p.z}return[c,T,d,R,m,u]},TR3.coordM2T=function(e,t,o,a){var n,r,i;if(a){if(!o)o=(s=TR3.getCoordsByXYmod(e,-t))&&s[2]?s[2]:TR3.zM2T(TR3.zMed,!0);n=e,r=TR3.zM2T(o,a),i=-t}else{var s;if(!t)t=(s=TR3.getCoordsByXYmod(e,-o))&&s[5]?s[5]:TR3.zM2T(TR3.zMed);n=e,r=-o,i=TR3.zM2T(t,a)}return[n,r,i]},TR3.zM2T=function(e,t){var o;return o=t?(e-TR3.zMed)*TR3.valuesSet.magnification:e/TR3.valuesSet.magnification+TR3.zMed,"string"!=typeof e?t?"number"==typeof o&&!isNaN(o)||(o="$"+e+"$T"):"number"==typeof o&&!isNaN(o)||(o="$"+e+"$M"):o=e,o},TR3.makeVectFeat=function(e,t,o,a){var n,r=new THREE.BufferGeometry,i=Math.round(16777215*Math.random()),s=new Array;if(s.color=o.color||i,s.side=o.side||THREE.DoubleSide,s.transparent=o.transparent||!1,s.wireframe=o.wireframe||!1,s.opacity=o.opacity||1,"Circle"==t){var l=new THREE.CircleGeometry(e.w,20);l.rotateX(Math.PI/2);for(var c=l.vertices,T=0;T<c.length;T++){c[T].x=e.x+c[T].x,c[T].z=e.z+c[T].z;var d=TR3.getCoordsByXYmod(c[T].x,c[T].z);d?c[T].y=d[4]:e.y?c[T].y=e.y:c[T].y=TR3.zMed}c.push(c[1]),c.shift(),r.setFromPoints(c);var R=new THREE.LineBasicMaterial({color:s.color});n=new THREE.LineLoop(r,R)}else if("Point"==t){r.setFromPoints(e);var m=50*TR3.getSizePix();R=new THREE.PointsMaterial({color:s.color,size:m});n=new THREE.Points(r,R)}else if("Poligon"==t){r.setFromPoints(e);R=new THREE.LineBasicMaterial({color:s.color});n=new THREE.LineLoop(r,R)}else{r.setFromPoints(e);R=new THREE.LineBasicMaterial({color:s.color});n=new THREE.Line(r,R)}return a&&(n.reload=a.reload||!1,n.magni=TR3.valuesSet.magnification,TR3.vGeom.item.unshift(n)),n},TR3.makeMeshFeat=function(e,t,o,a){var n,r=Math.round(16777215*Math.random()),i=new Array;i.color=o.color||r,i.side=o.side||THREE.DoubleSide,i.transparent=o.transparent||!1,i.wireframe=o.wireframe||!1,i.opacity=o.opacity||1;var s=new THREE.MeshBasicMaterial({color:i.color,side:i.side,transparent:i.transparent,wireframe:i.wireframe,opacity:i.opacity});return"Basic"==t&&(n=new THREE.Mesh(e,s)),a&&(n.reload=a.reload||!1,n.magni=TR3.valuesSet.magnification,TR3.vGeom.item.unshift(n)),n},TR3.getLookAt=function(){var e=TR3.getIntersect()[0].point,t=TR3.camera.position.clone();return[e.x,e.y,e.z,t.x,t.y,t.z]},TR3.setLookAtini=function(e,t){var o=2*TR3.fov*Math.PI/360,a=TR3.zone,n=(TR3.tPixMesh,Math.cos(o/2)*(a[3]-a[1])/(2*Math.sin(o/2))),r=(a[2]+a[0])/2,i=-(a[3]+a[1])/2;("number"!=typeof e||isNaN(e)||e<5)&&(e=100),("number"!=typeof t||isNaN(t)||t<0)&&(t=4);var s=n/t,l=TR3.getCoordsDistance3D([r,i,0],[a[2],-a[1],s]),c=TR3.rectaValue3D(r,i,0,a[2],-a[1],s,r+e/100*l);TR3.setLookAt([r,0,i,c[0],s,c[1]])},TR3.setLookAt=function(e,t){var o={x:e[3],y:e[4],z:e[5]},a=new THREE.Vector3(e[0],e[1],e[2]);(e[0]<TR3.bboxImgOri[0]||e[0]>TR3.bboxImgOri[2])&&(a=new THREE.Vector3((TR3.bboxImgOri[0]+TR3.bboxImgOri[2])/2,0,-(TR3.bboxImgOri[1]+TR3.bboxImgOri[3])/2)),new TWEEN.Tween(TR3.camera.position).to(o,2e3).easing(TWEEN.Easing.Linear).on("start",function(){TR3.controls.target=a,TR3.controls.update(),TR3.lookAt=!1}).on("complete",function(){TR3.mesh.rotation.z=0,TR3.CameraMoveEvEnd(),t&&!TR3.config.unic&&(IIIkel.AFs.skinMap.setCenterMap(t.pos),t.lyr&&IIIkel.AFs.skinMap.setVisibleLayer(IIIkel.AFs.skinMap.getLayersByName(t.lyr)[0],!0))}).start()},TR3.goScenes=function(e){var t=e||TR3.config.actual.loc;TR3.config.lookAt=t.look,TR3.setLookAt(TR3.config.lookAt,t),TR3.setOpts({autoRotate:!0})},TR3.oscillator=function(e,t,o,a,n){return Math.sin(e*t*Math.PI*2+a*Math.PI*2)*o+n},TR3.makeWorld=function(e){"object"==typeof e?TR3.makeObjects(e):-1==e.toUpperCase().indexOf("HTTP://")?TR3.obtainImageFromID(e):TR3.obtainImageFromPath(e)},TR3.obtainImageFromPath=function(e){var t=new Image,o=5;t.onload=function(){TR3.makeObjects(t)},t.onerror=function(){0<=o?(t.src=e,o--):(alert("can not load image correctly"),TR3.loadingDiv.style.display="none")},t.crossOrigin="anonymus",t.src=e},TR3.obtainImageFromID=function(e){var t=document.getElementById(e);TR3.makeObjects(t)},TR3.makeScene=function(){var e=2*TR3.fov*Math.PI/360,t=TR3.zone,o=TR3.tPixMesh,a=TR3.rectaValue(7e3,2e4,55,350,o);a<50&&(a=50),TR3.controls.keyPanSpeed=a,TR3.controls.enableKeys=!1,TR3.controls.maxPolarAngle=Math.PI/2,TR3.moveKey.walk=!1;var n=Math.cos(e/2)*(t[3]-t[1])/(2*Math.sin(e/2)),r=(t[2]+t[0])/2,i=-(t[3]+t[1])/2;TR3.camera.position.set(r,n,i),TR3.startPos={x:TR3.camera.position.x,y:TR3.camera.position.y,z:TR3.camera.position.z},TR3.mesh.rotation.x=3*Math.PI/2,TR3.mesh.position.set(r,0,i),TR3.starField.position.set(r,0,i),TR3.txtObject("N","#888888",3e4,[r,2e5,i-13e5],0),TR3.txtObject("S","#888888",3e4,[r,2e5,13e5+i],Math.PI),TR3.txtObject("E","#888888",3e4,[13e5+r,2e5,i],-Math.PI/2),TR3.txtObject("W","#888888",3e4,[r-13e5,2e5,i],Math.PI/2),TR3.controls.target.set(r,0,i),TR3.camera.near=1,TR3.camera.far=5e6,TR3.camera.fov=TR3.fov,TR3.zeroParallax=n,TR3.cursor.helper.scale.set(1,1,1),TR3.renderScene(),TR3.initSky(r,0,i)},TR3.initSky=function(e,t,o){var a=TR3.scene.getObjectByName("Sky");a.scale.setScalar(45e9),a.position.set(e,t,o),a.rotation.y=Math.PI/2;var n=new THREE.Vector3,r=0,i=.5,s=.005,l=.7,c=.49,T=.25,d=.5;!function(){var e=a.material.uniforms;e.turbidity.value=r,e.rayleigh.value=i,e.mieCoefficient.value=s,e.mieDirectionalG.value=l;var t=Math.PI*-(c-.5),o=2*Math.PI*-(T-.5);n.x=Math.cos(o),n.y=Math.sin(o)*Math.sin(t),n.z=Math.sin(o)*Math.cos(t),e.sunPosition.value.copy(n),TR3.renderer.toneMappingExposure=d,TR3.renderer.render(TR3.scene,TR3.camera)}()},TR3.makeSteve=function(){var e=new THREE.Vector3(1,-1,0).unproject(TR3.camera),t=[.12,.12,1],o=new THREE.Mesh(new THREE.BoxGeometry(t[0],t[1],t[2]),new THREE.MeshBasicMaterial({color:14540253}));o.position.copy(e),TR3.camera.add(o);var a=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(t[0],t[1],t[2])),new THREE.LineBasicMaterial({color:11184810}));o.add(a);var n=new THREE.Object3D;n.position.copy(e),TR3.camera.add(n)},TR3.makeObjects=function(e){TR3.widthImg=e.width,TR3.heightImg=e.height;var t=TR3.zone,o=new THREE.Texture(e);o.needsUpdate=!0,o.minFilter=THREE.LinearFilter;for(var a=new THREE.MeshBasicMaterial({map:o}),n=89;n+=1,TR3.reducMesh=1-n/100,TR3.reducMeshW=Math.round(TR3.widthImg*TR3.reducMesh),TR3.reducMeshH=Math.round(TR3.heightImg*TR3.reducMesh),TR3.getSizePix()/TR3.reducMesh<TR3.maxResolMesh;);TR3.tPixImg=TR3.getSizePix(),TR3.tPixMesh=TR3.tPixImg/TR3.reducMesh;var r=new THREE.PlaneBufferGeometry(t[2]-t[0],t[3]-t[1],TR3.reducMeshW,TR3.reducMeshH);TR3.mesh=new THREE.Mesh(r,a),TR3.mesh.geometry.dynamic=!0,TR3.mesh.name="mesh3d",TR3.scene.add(TR3.mesh);var i=new THREE.MeshPhongMaterial({color:7829367,shininess:40,specular:2236962,flatShading:THREE.SmoothShading,side:THREE.DoubleSide}),s=new THREE.IcosahedronGeometry(3e4,3),l=new THREE.Mesh(s,i);l.name="moon",TR3.scene.add(l),TR3.moon=l;for(var c=new THREE.BufferGeometry,T=[],d=0;d<500;d++){var R=new THREE.Vector3,m=THREE.Math.randFloat(0,2*Math.PI),u=THREE.Math.randFloat(-Math.PI/2,Math.PI/2);R.x=2e6*Math.sin(m)*Math.cos(u),R.y=2e6*Math.sin(m)*Math.sin(u),R.z=2e6*Math.cos(m),T.push(R)}c.setFromPoints(T);var p=new THREE.PointsMaterial({color:"#cccc88",size:1e4});TR3.starField=new THREE.Points(c,p),TR3.starField.name="starField",TR3.starField.rotation.x=Math.PI/2,TR3.scene.add(TR3.starField);(r=new THREE.CylinderGeometry((t[2]-t[0])/200,0,(t[2]-t[0])/50,3)).applyMatrix4((new THREE.Matrix4).makeTranslation(0,(t[2]-t[0])/100,0)),TR3.cursor.helper=new THREE.Mesh(r,new THREE.MeshNormalMaterial),TR3.cursor.helper.name="cursor",TR3.cursor.helper.visible=!1,TR3.scene.add(TR3.cursor.helper),TR3.quaternion=new THREE.Quaternion,TR3.makeScene(),TR3.makeZmesh()},TR3.cvsDesty=function(){var e;return(e=document.getElementById("canvasDest"))&&e.remove(),(e=TR3.canvasDest)||((e=document.createElement("CANVAS")).id="canvasDest",TR3.config.unic||(e.style.position="absolute",e.style.top="0px",e.style.left="0px"),TR3.map.insertAdjacentElement("afterbegin",e)),e},TR3.divLoading=function(){var e=document.getElementById("infoGeo3d");e||((e=document.createElement("div")).id="infoGeo3d",e.style.position="absolute",e.style.fontSize="10px",e.style.margin="25px",e.style.backgroundColor="#fff",e.style.top="10px",e.style.zIndex="10",TR3.map.appendChild(e));var t=TR3.loadingDiv;t?(t.innerHTML="&nbsp;&nbsp;&nbsp;Loading ...&nbsp;&nbsp;&nbsp;",t.style.display="block"):((t=document.createElement("div")).id="loadingTerrain",t.style.position="absolute",t.style.top="0px",t.style.marginTop=TR3.canvasDestH/2+"px",t.style.marginLeft=TR3.canvasDestW/2.5+"px",t.style.fontSize="15px",t.style.backgroundColor="#bbb",t.style.border="solid",t.innerHTML="&nbsp;&nbsp;&nbsp;Loading ...&nbsp;&nbsp;&nbsp;",TR3.map.appendChild(t)),TR3.loadingDiv=t},TR3.divContainer=function(){"object"!=typeof TR3.map&&(TR3.map=document.getElementById(TR3.map)),TR3.canvasDestW=TR3.map.clientWidth||parseInt(TR3.map.style.width)||document.documentElement.offsetWidth,TR3.canvasDestH=TR3.map.clientHeight||parseInt(TR3.map.style.height)||document.documentElement.offsetHeight},TR3.setImageMesh=function(e){var t=new THREE.Texture(e);t.needsUpdate=!0,t.minFilter=THREE.LinearFilter,TR3.mesh.material.map=t},TR3.setMeshZone=function(){0==TR3.newMeshMap&&TR3.widthImg&&(TR3.loadingDiv.style.display="block",TR3.makeScene())},TR3.assignZmesh=function(){for(var e=TR3.arrayZ,t=e[0],o=e[0],a=0;a<e.length;a++)e[a]<t&&(t=e[a]),e[a]>o&&(o=e[a]);var n=TR3.reducMeshH+1,r=TR3.reducMeshW+1,i=Math.round(n/2)*r+Math.round(r/2);TR3.zMed=e[i],TR3.zMax=o,TR3.zMin=t;var s=TR3.mesh.geometry.getAttribute("position");for(a=0;a<e.length;a++)s.setZ(a,(e[a]-TR3.zMed)*TR3.valuesSet.magnification);TR3.renderScene(),s.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals(),1==TR3.newMeshMap?TR3.onCompleteMap():TR3.loadingDiv.style.display="none"},TR3.obtainZmeshWCS=function(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM){TR3.requestDTMwcs&&TR3.requestDTMwcs.abort(),TR3.requestDTMwcs=new XMLHttpRequest;var tPixMesh=TR3.tPixMesh,posName=1e3;if(1e3<tPixMesh);else if(tPixMesh<1e3&&500<=tPixMesh)var posName=1e3;else if(tPixMesh<500&&200<=tPixMesh)var posName=200;else if(tPixMesh<200&&25<=tPixMesh)var posName=25;else var posName=5;var c1=proj4(proj4.defs(TR3.srsImg),proj4.defs("EPSG:4326"),[bboxDTM0,bboxDTM1]),preName="Elevacion25830_";(c1[0]<-13||c1[1]<29.5)&&(preName="Elevacion4083_"),TR3.requestDTMwcs.open("GET","https://servicios.idee.es/wcs-inspire/mdt?SERVICE=WCS&REQUEST=GetCoverage&VERSION=1.0.0&FORMAT=ArcGrid&CRS="+srsDTM+"&BBOX="+bboxDTM0+","+bboxDTM1+","+bboxDTM2+","+bboxDTM3+"&WIDTH="+widthDTM+"&HEIGHT="+heightDTM+"&COVERAGE="+preName+posName),TR3.requestDTMwcs.onload=function(){var txtDTMwcs=TR3.requestDTMwcs.responseText,str="\n ";if(txtDTMwcs&&-1!=txtDTMwcs.indexOf(str)){var zConteint=txtDTMwcs.slice(txtDTMwcs.indexOf(str)+str.length),sinSalto=zConteint.replace(/\r\n/g," "),sinFin=sinSalto.slice(0,sinSalto.length-1),arrayZ=sinFin.split(" "),lengthDTM=widthDTM*heightDTM,evalZ;if(arrayZ.length<100)TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM);else{for(var i=0;i<lengthDTM;i++)TR3.arrayZ[i]=evalZ=eval(arrayZ[i]),(evalZ<-1e3||4e3<evalZ)&&(TR3.arrayZ[i]=0);TR3.assignZmesh()}}else TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM);TR3.requestDTMwcs=!1},TR3.requestDTMwcs.onerror=function(e){TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM)},TR3.requestDTMwcs.send()},TR3.errorDTMwcs=function(e,t,o,a,n,r,i){for(var s=e*t,l=0;l<s;l++)TR3.arrayZ[l]=0;TR3.assignZmesh(),setTimeout(function(){TR3.obtainZmeshWCS(e,t,o,a,n,r,i)},3e3)},TR3.makeZmesh=function(){var arrZ,widthDTM=TR3.reducMeshW+1,heightDTM=TR3.reducMeshH+1,bboxDTM0=eval(TR3.bboxImgOri[0])-TR3.tPixMesh/2,bboxDTM1=eval(TR3.bboxImgOri[1])-TR3.tPixMesh/2,bboxDTM2=eval(TR3.bboxImgOri[2])+TR3.tPixMesh/2,bboxDTM3=eval(TR3.bboxImgOri[3])+TR3.tPixMesh/2,srsDTM=TR3.srsImg;TR3.arrayZ=[],arrZ=TR3.obtainZmeshWCS(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM)},TR3.setMagniValues=function(e){var t=TR3.valuesSet.magnification;if(isNaN(parseFloat(e))){var o=TR3.tPixMesh,a=Math.round(TR3.rectaValue(7e3,11,5,1,o)),n=Math.abs(TR3.zMax-TR3.zMin),r=Math.abs(TR3.bboxImgOri[2]-TR3.bboxImgOri[0]),i=Math.abs(TR3.bboxImgOri[3]-TR3.bboxImgOri[1]);(0<r-i?r:i)/n<=25&&(a/=4),(o<90||a<1)&&(a=1),15<a&&(a=15),TR3.valuesSet.magnification=a}else TR3.valuesSet.magnification=Math.round(e);return t!=e&&0==TR3.newMeshMap&&TR3.widthImg&&(TR3.assignZmesh(),TR3.assignZgeometries(),TR3.newDraw=-1),TR3.valuesSet.magnification};